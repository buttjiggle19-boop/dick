<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PicPopper Mobile Simulator v7.4 (Communities)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* CSS Variables for Modern X/Twitter Mobile Theme */
        :root {
            --primary-blue: #1d9bf0; 
            --primary-purple: #8000ff; /* New theme color */
            --x-dark: #000000;
            --x-light-gray: #16181c; 
            --x-text-color: #e7e9ea;
            --x-dim-text: #71767b; 
            --x-border: #2f3336;
        }

        /* --- Theme-Specific Styles --- */
        /* This dynamic block will be controlled by JavaScript */
        .theme-color-dynamic {
            color: var(--primary-color);
        }
        .theme-bg-dynamic {
            background-color: var(--primary-color);
        }
        .tab-item.active::after {
            background-color: var(--primary-color);
        }
        .header-logo {
            color: var(--primary-color); /* Updated for theme */
        }
        .avatar {
            color: var(--x-text-color); /* Avatar text is always light on dark theme */
            background-color: var(--primary-color); /* Updated for theme */
        }
        .verified-badge {
            color: var(--primary-color);
        }
        .fab-post {
            background-color: var(--primary-color); /* Updated for theme */
        }
        .nav-item.active {
            color: var(--primary-color); /* Updated for theme */
        }
        .modal-header button {
            background-color: var(--primary-color); /* Updated for theme */
        }
        .modal-header button:disabled {
            background-color: color-mix(in srgb, var(--primary-color) 70%, var(--x-dark));
            opacity: 0.7;
        }
        .edit-form-group label {
            color: var(--primary-color);
        }

        /* Base Body and Container Setup */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--x-dark);
            color: var(--x-text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 0;
            overflow-x: hidden;
            height: 100vh;
        }

        .simulator-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--x-dark);
            min-height: 100vh;
            position: relative;
            /* Space for sticky header (55px) and footer (55px) */
            padding-top: 55px; 
            padding-bottom: 55px; 
            box-sizing: border-box;
        }

        /* ---------------------------------- */
        /* 1. HEADER & NAVIGATION             */
        /* ---------------------------------- */
        .header-container {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 600px;
            background-color: var(--x-dark);
            z-index: 1000;
            border-bottom: 1px solid var(--x-border);
        }
        
        .top-header {
            height: 55px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        
        .header-logo {
            font-size: 20px;
            font-weight: 900;
            cursor: pointer; 
        }
        
        .header-logo i {
            margin-right: 5px;
        }
        
        .header .icon {
             font-size: 20px;
             color: var(--x-text-color);
        }

        /* Avatar Styling (Updated for PFP image support) */
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
            flex-shrink: 0; 
            /* Added for PFP image */
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }
        .avatar:active { transform: scale(0.9); }
        
        .header-tabs {
            display: flex;
            justify-content: space-around;
            height: 50px;
            border-bottom: 1px solid var(--x-border);
        }

        .tab-item {
            padding: 0 10px;
            color: var(--x-dim-text);
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .tab-item.active {
            color: var(--x-text-color);
        }
        
        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 4px;
            border-radius: 2px;
            animation: tabUnderline 0.3s ease-out;
        }
        
        /* ---------------------------------- */
        /* 2. POST DISPLAY & ANIMATION        */
        /* ---------------------------------- */
        .feed {
            min-height: 500px; 
        }

        /* POST LAYOUT FIX */
        .post {
            padding: 15px 15px 0 15px; /* Adjust padding for better look */
            border-bottom: 1px solid var(--x-border);
            display: flex;
            animation: fadeIn 0.3s ease-in-out;
            cursor: pointer; 
        }

        /* Post content column, next to the avatar */
        .post-content-container {
            flex-grow: 1;
            padding-left: 10px;
            padding-bottom: 15px; /* Move bottom padding here */
        }

        /* Fix post header alignment to match the new structure */
        .post-header-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px; /* Added spacing */
        }
        
        /* Stat Update Animation */
        .stat-animated {
            animation: statPulse 0.5s ease-out;
        }
        
        @keyframes statPulse {
            0% { color: var(--primary-color); transform: scale(1); }
            50% { color: var(--primary-color); transform: scale(1.1); }
            100% { color: var(--x-dim-text); transform: scale(1); }
        }

        /* Hashtag Styling */
        .post-content a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .post-content a:hover {
            text-decoration: underline;
        }


        /* --- POST ACTIONS FIX --- */
        .post-actions {
            display: flex;
            /* Changed from space-between to flex-start to allow the share button to be pushed to the right */
            justify-content: flex-start;
            gap: 20px; /* Spacing between the first four actions */
            margin-top: 15px;
            color: var(--x-dim-text);
            font-size: 13px;
            max-width: 450px;
        }

        .action-item {
            display: flex;
            align-items: center;
            gap: 5px; /* Spacing between icon and count */
            cursor: pointer;
            padding: 5px 0;
            transition: color 0.1s, transform 0.1s;
        }
        
        .post-actions .share {
            margin-left: auto; /* Pushes the share icon to the far right */
            gap: 0; /* Share button doesn't have a count */
        }

        /* ---------------------------------- */
        /* 2b. POST DETAIL VIEW               */
        /* ---------------------------------- */
        #postDetailView {
            display: none;
            position: relative;
        }
        .post-detail-header {
            position: sticky;
            top: 55px;
            z-index: 999;
            background-color: var(--x-dark);
            border-bottom: 1px solid var(--x-border);
            padding: 10px 15px;
        }
        .post-detail-header i {
            font-size: 20px;
            cursor: pointer;
        }
        .post-detail-post-container {
            padding: 15px;
            border-bottom: 1px solid var(--x-border);
        }
        .post-detail-post-container .post-body {
            padding-left: 0; 
        }
        .post-detail-post-container .post-header-info {
            margin-bottom: 10px;
        }
        .post-detail-post-container .avatar {
            width: 48px;
            height: 48px;
            font-size: 20px;
        }
        .post-detail-content {
            font-size: 18px;
            line-height: 1.4;
            margin-bottom: 15px;
        }
        .post-detail-timestamp {
            color: var(--x-dim-text);
            font-size: 14px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--x-border);
        }
        .post-detail-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--x-border);
        }
        .post-detail-stats strong {
            color: var(--x-text-color);
            margin-right: 5px;
        }
        /* Detail actions need to be spread out again since they don't have counts */
        .post-detail-actions {
            justify-content: space-around !important;
            max-width: 100% !important;
        }
        .comments-section {
            padding: 15px;
            text-align: center;
            color: var(--x-dim-text);
        }

        /* ---------------------------------- */
        /* 2c. TRENDING VIEW                  */
        /* ---------------------------------- */
        #trendingView {
            display: none;
            padding: 5px 0;
        }
        .trending-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--x-border);
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .trending-item:hover {
            background-color: var(--x-light-gray);
        }
        .trending-category {
            font-size: 12px;
            color: var(--x-dim-text);
        }
        .trending-hashtag {
            font-size: 16px;
            font-weight: bold;
            color: var(--x-text-color);
            margin: 2px 0;
        }
        .trending-views {
            font-size: 14px;
            color: var(--x-dim-text);
        }
        
        /* ---------------------------------- */
        /* 3. PROFILE PAGE VIEW               */
        /* ---------------------------------- */
        #profileView {
            display: none;
            padding: 0;
        }
        
        .profile-content-scroll {
             height: 100%;
             overflow-y: auto;
             -webkit-overflow-scrolling: touch;
        }

        .profile-header-container {
            position: relative;
            background-color: var(--x-dark);
            padding-top: 55px; /* Space for the fixed header */
        }

        .banner {
            width: 100%;
            height: 150px;
            /* Banner will get its background from JS/userProfile.banner */
            background: linear-gradient(135deg, var(--primary-color), #333); 
        }

        .profile-details {
            padding: 0 15px 15px 15px;
            margin-top: -60px;
        }

        .profile-page-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--x-dark);
            font-size: 30px;
            margin-bottom: 10px;
        }

        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 15px;
        }

        .stat-item {
            color: var(--x-dim-text);
        }
        .stat-item strong {
            color: var(--x-text-color);
            margin-right: 5px;
            transition: color 0.5s, transform 0.5s; /* Ensure strong is part of animation */
        }
        
        .follow-button, #editProfileButton {
            float: right;
            background-color: var(--x-text-color);
            color: var(--x-dark);
            border: none;
            padding: 8px 18px;
            border-radius: 9999px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -30px;
            transition: background-color 0.2s;
        }
        #editProfileButton {
            background-color: var(--x-dark);
            color: var(--x-text-color);
            border: 1px solid var(--x-border);
        }
        
        /* ---------------------------------- */
        /* 4. MODAL STYLING (Post & Edit & Premium & Community) */
        /* ---------------------------------- */
        #postModal, #editProfileModal, #settingsModal, #premiumModal, #hashtagModal, #createCommunityModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--x-dark); 
            z-index: 2000;
            justify-content: center;
            align-items: flex-start;
        }

        .modal-content {
            width: 100%;
            max-width: 600px;
            background-color: var(--x-dark);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--x-border);
            padding: 10px 15px;
            flex-shrink: 0;
        }
        
        .modal-header .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--x-text-color);
            padding: 5px;
        }

        .edit-form-group {
            margin-bottom: 20px;
        }
        .edit-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        .edit-form-group input, .edit-form-group textarea {
            width: 100%;
            padding: 10px;
            background-color: var(--x-light-gray);
            border: 1px solid var(--x-border);
            border-radius: 6px;
            color: var(--x-text-color);
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
        }

        /* Settings List Styles */
        .settings-list {
            padding: 15px;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--x-border);
            cursor: pointer;
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .theme-options button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--x-border);
            margin-left: 5px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .theme-options button.active {
            border-color: var(--x-text-color);
            border-width: 4px;
        }
        
        /* ---------------------------------- */
        /* 5. COMMUNITIES VIEW                */
        /* ---------------------------------- */
        #communitiesView {
            display: none;
        }
        .community-list {
            padding: 15px;
        }
        .community-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--x-border);
            cursor: pointer;
        }
        .community-item:last-child {
            border-bottom: none;
        }
        .community-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }
        .community-details {
            margin-left: 15px;
        }
        .community-details .members {
            color: var(--x-dim-text);
            font-size: 14px;
        }
        .create-community-prompt {
            padding: 20px;
            text-align: center;
        }
        .create-community-prompt h3 {
            margin-top: 0;
        }

        
        /* ---------------------------------- */
        /* 6. OTHER STYLES (Bottom Nav, FAB)  */
        /* ---------------------------------- */

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px;
            height: 55px;
            background-color: var(--x-dark);
            border-top: 1px solid var(--x-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        .nav-item {
            color: var(--x-dim-text);
            font-size: 22px;
            padding: 10px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .fab-post {
            position: fixed;
            bottom: 70px;
            right: 15px;
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            z-index: 1001;
            right: calc(50% - 300px + 15px);
        }
        
        @media (max-width: 600px) {
            .fab-post {
                right: 15px;
            }
        }
    </style>
</head>
<body>

<div class="simulator-container">

    <div class="header-container" id="headerContainer">
        <div class="top-header">
            <div class="avatar" id="headerAvatar" onclick="showProfile('user')">Y</div>
            <div class="header-logo" onclick="switchTab('home')"><i class="fas fa-camera"></i>PicPopper</div>
            <i class="far fa-bell icon" onclick="switchTab('notifications')"></i>
        </div>
        <div class="header-tabs main-view-tabs" id="headerTabs">
            <div class="tab-item active" data-tab="home" onclick="switchTab('home')">For You</div>
            <div class="tab-item" data-tab="trending" onclick="switchTab('trending')">Trending</div>
        </div>
    </div>
    
    <div id="mainView" style="display: block;">
        <div class="feed" id="feed"></div>
    </div>
    
    <div id="trendingView" style="display: none;">
        <h2 style="padding: 10px 15px;">What's trending</h2>
        <div id="trendingList"></div>
    </div>

    <div id="communitiesView" style="display: none; padding-top: 5px;">
        <div class="community-list" id="communityList">
            </div>
    </div>

    <div id="postDetailView" style="display: none;">
        <div class="post-detail-header">
            <i class="fas fa-arrow-left icon" onclick="switchTab(document.getElementById('postDetailView').getAttribute('data-previous-tab') || 'home')"></i>
        </div>
        <div id="postDetailContent">
            </div>
    </div>

    <div id="profileView" style="display: none;">
        <div class="profile-header-container">
            <div class="top-header" style="position: absolute; width: 100%; max-width: 600px; padding: 0 10px; background: none; border-bottom: none;">
                <i class="fas fa-arrow-left icon" onclick="switchTab('home')" style="cursor:pointer; background: rgba(0,0,0,0.5); padding: 5px 8px; border-radius: 50%; color: white;"></i>
                <i class="fas fa-ellipsis-v icon" style="background: rgba(0,0,0,0.5); padding: 5px 8px; border-radius: 50%; color: white;"></i>
            </div>
            
            <div class="profile-content-scroll" style="height: calc(100vh - 55px);">

                <div class="banner" id="profileBanner"></div>
                <div class="profile-details">
                    <button class="follow-button" id="editProfileButton" onclick="openEditProfileModal()">Edit Profile</button>
                    <button class="follow-button" id="followButton" style="display: none;">Follow</button>
                    
                    <div class="avatar profile-page-avatar" id="profilePageAvatar">Y</div>
                    
                    <h2 style="margin: 0; display: flex; align-items: center;" id="profileDisplayNameContainer">
                        <span id="profileDisplayName"></span>
                        <i class="fas fa-certificate verified-badge"></i>
                    </h2>
                    <span style="color: var(--x-dim-text);" id="profileHandle"></span>
                    
                    <p class="profile-bio" id="profileBio"></p>
                    
                    <div class="profile-location"><i class="fas fa-location-dot"></i><span id="profileLocation"></span></div>
                    <div class="profile-joined"><i class="fas fa-calendar-alt"></i>Joined <span id="profileJoined"></span></div>

                    <div class="profile-stats">
                        <div class="stat-item"><strong id="profilePostCount">0</strong> Posts</div>
                        <div class="stat-item"><strong id="profileFollowingCount">0</strong> Following</div>
                        <div class="stat-item"><strong id="profileFollowerCount">0</strong> Followers</div>
                    </div>
                </div>
                
                <div class="header-tabs">
                    <div class="tab-item active">Posts</div>
                    <div class="tab-item">Likes (Simulated)</div>
                </div>
                
                <div id="profilePostsFeed" class="feed"></div>
            </div>
        </div>
    </div>

    <div class="fab-post theme-bg-dynamic" onclick="openPostModal()">
        <i class="fas fa-plus"></i>
    </div>

    <div class="bottom-nav" id="bottomNav">
        <div class="nav-item active" data-tab="home" onclick="switchTab('home', this)"><i class="fas fa-house"></i></div>
        <div class="nav-item" data-tab="trending" onclick="switchTab('trending', this)"><i class="fas fa-magnifying-glass"></i></div>
        <div class="nav-item" data-tab="communities" onclick="switchTab('communities', this)"><i class="fas fa-users"></i></div>
        <div class="nav-item" data-tab="notifications" onclick="switchTab('notifications', this)"><i class="far fa-bell"></i></div>
        <div class="nav-item" data-tab="settings" onclick="openSettingsModal(this)"><i class="fas fa-gear"></i></div> </div>
    
</div>

<div id="postModal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closePostModal()"><i class="fas fa-times"></i></span>
            <button id="modalPostButton" onclick="postTweet()" disabled>Post</button>
        </div>
        <div class="modal-post-area" style="display: flex; padding: 15px;">
            <div class="avatar" id="modalAvatar">Y</div>
            <textarea id="postText" class="modal-textarea" placeholder="What's popping?" oninput="checkPostLength()" style="flex-grow: 1; margin-left: 10px; background: transparent; border: none; color: var(--x-text-color); font-size: 20px; outline: none; resize: none;"></textarea>
        </div>
        <div class="modal-footer" style="padding: 10px 15px; border-top: 1px solid var(--x-border); margin-top: auto; display: flex; justify-content: space-between;">
            <div>
                <i class="far fa-image icon" style="margin-right: 15px;"></i>
                <i class="fas fa-bars-staggered icon" style="margin-right: 15px;"></i>
                <i class="far fa-face-smile icon"></i>
            </div>
        </div>
    </div>
</div>

<div id="editProfileModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closeEditProfileModal()"><i class="fas fa-times"></i></span>
            <h3 style="margin:0; font-weight: bold;">Edit Profile</h3>
            <button onclick="saveProfileChanges()">Save</button>
        </div>
        <div style="padding: 15px; overflow-y: auto;">
            <div class="banner" id="editBanner" style="height: 100px; margin-bottom: -50px; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('pfpInput').click()">
                </div>
            
            <div class="avatar profile-page-avatar" id="editProfileAvatar" style="cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('pfpInput').click()">Y</div>
            <input type="file" id="pfpInput" accept="image/*" style="display: none;">
            
            <p style="color: var(--x-dim-text); font-size: 14px; margin-top: 10px;">Click the avatar or banner to change your profile picture.</p>

            <div class="edit-form-group">
                <label for="editDisplayName">Name</label>
                <input type="text" id="editDisplayName" maxlength="15">
            </div>
            <div class="edit-form-group">
                <label for="editFollowers">Followers (for growth demo)</label>
                <input type="text" id="editFollowers" maxlength="10">
            </div>
            <div class="edit-form-group">
                <label for="editBio">Bio</label>
                <textarea id="editBio" maxlength="160"></textarea>
            </div>
            <div class="edit-form-group">
                <label for="editLocation">Location</label>
                <input type="text" id="editLocation" maxlength="30">
            </div>
            <div class="edit-form-group">
                <label for="editJoined">Joined Date (e.g., Nov 2023)</label>
                <input type="text" id="editJoined" maxlength="30">
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closeSettingsModal()"><i class="fas fa-arrow-left"></i></span>
            <h3 style="margin:0; font-weight: bold;">Settings</h3>
            <div></div> </div>
        <div class="settings-list">
            <div class="setting-item" onclick="openPremiumModal()">
                <span style="font-weight: bold; color: gold;"><i class="fas fa-star" style="margin-right: 5px;"></i> PicPopper Premium</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="setting-item">
                <span style="font-weight: bold;">Theme Color</span>
                <div class="theme-options" id="themeOptions">
                    <button style="background-color: #1d9bf0;" data-color="#1d9bf0" onclick="applyTheme('#1d9bf0')"></button>
                    <button style="background-color: #8000ff;" data-color="#8000ff" onclick="applyTheme('#8000ff')"></button>
                    <button style="background-color: #00ff00;" data-color="#00ff00" onclick="applyTheme('#00ff00')"></button>
                    <button style="background: linear-gradient(45deg, #FF6B6B, #FFD93D);" data-color="linear-gradient(45deg, #FF6B6B, #FFD93D)" onclick="applyTheme('linear-gradient(45deg, #FF6B6B, #FFD93D)')" disabled title="Premium Only"></button>
                    <button style="background: linear-gradient(135deg, #4A90E2, #50E3C2);" data-color="linear-gradient(135deg, #4A90E2, #50E3C2)" onclick="applyTheme('linear-gradient(135deg, #4A90E2, #50E3C2)')" disabled title="Premium Only"></button>
                    <button style="background: linear-gradient(90deg, #E91E63, #9C27B0);" data-color="linear-gradient(90deg, #E91E63, #9C27B0)" onclick="applyTheme('linear-gradient(90deg, #E91E63, #9C27B0)')" disabled title="Premium Only"></button>
                </div>
            </div>
            <div class="setting-item" onclick="alert('Display settings coming soon!')">
                <span style="font-weight: bold;">Display and language</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="setting-item" onclick="alert('Privacy settings coming soon!')">
                <span style="font-weight: bold;">Privacy and safety</span>
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>
</div>

<div id="premiumModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closePremiumModal()"><i class="fas fa-arrow-left"></i></span>
            <h3 style="margin:0; font-weight: bold; color: gold;">PicPopper Premium</h3>
            <div></div> </div>
        <div class="settings-list" style="padding: 15px; text-align: center;">
            <p style="font-size: 18px; margin-bottom: 20px;">Unlock exclusive features for only <strong style="color: gold;">$10 / month (Simulated)</strong>.</p>
            
            <div style="text-align: left; margin-bottom: 25px;">
                <h4 style="margin-top: 0; color: gold;"><i class="fas fa-crown"></i> Premium Features:</h4>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 10px;"><i class="fas fa-check-circle theme-color-dynamic" style="margin-right: 8px;"></i> **3 Gradient Themes** or upload your own background.</li>
                    <li style="margin-bottom: 10px;"><i class="fas fa-check-circle theme-color-dynamic" style="margin-right: 8px;"></i> Choose your **Custom Badge** to display on posts.</li>
                    <li style="margin-bottom: 10px;"><i class="fas fa-check-circle theme-color-dynamic" style="margin-right: 8px;"></i> **Boost your View Count** growth multiplier! (Currently ${userProfile.isPremium ? '3x' : '1x'})</li>
                </ul>
            </div>

            <button class="follow-button theme-bg-dynamic" style="width: 100%; margin-bottom: 15px;" onclick="promptPremiumCode()">${userProfile.isPremium ? 'Premium is ACTIVE!' : 'Activate Premium Now'}</button>
            <p style="color: var(--x-dim-text); font-size: 14px;">Enter the hidden code to simulate activation.</p>
        </div>
    </div>
</div>

<div id="hashtagModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closeHashtagModal()"><i class="fas fa-arrow-left"></i></span>
            <h3 style="margin:0; font-weight: bold;" id="hashtagModalTitle"></h3>
            <div></div> 
        </div>
        <div id="hashtagPostsFeed" class="feed" style="overflow-y: auto;">
        </div>
    </div>
</div>

<div id="createCommunityModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closeCreateCommunityModal()"><i class="fas fa-times"></i></span>
            <h3 style="margin:0; font-weight: bold;">Create New Community</h3>
            <button id="createCommunityButton" onclick="createCommunity()">Create</button>
        </div>
        <div style="padding: 15px; overflow-y: auto;">
            <p style="color: var(--x-dim-text);">
                Creating a community will give your posts a massive, sustained view boost!
            </p>
            <div class="edit-form-group">
                <label for="communityTitle">Community Title (e.g., #AI_Art)</label>
                <input type="text" id="communityTitle" maxlength="25" oninput="checkCommunityInputs()">
            </div>
            <div class="edit-form-group">
                <label for="communityBanner">Banner Image URL (Simulated Color/URL)</label>
                <input type="text" id="communityBanner" placeholder="Enter a color code (e.g., #ff00ff) or 'gradient'" oninput="checkCommunityInputs()">
            </div>
            <div class="edit-form-group">
                <label for="communityMembers">Starting Members (e.g., 50K, 2.5M)</label>
                <input type="text" id="communityMembers" placeholder="Enter a number with K or M suffix" oninput="checkCommunityInputs()">
            </div>
        </div>
    </div>
</div>
<script>
    // --- Global Variables and Constants ---
    const STORAGE_KEY_POSTS = 'picpopper_user_posts_v7_4';
    const STORAGE_KEY_PROFILE = 'picpopper_user_profile_v7_4'; 
    const STORAGE_KEY_BOT_POSTS = 'picpopper_bot_posts_v7_4';
    const STORAGE_KEY_LAST_SESSION = 'picpopper_last_session_v7_4';
    const STORAGE_KEY_THEME = 'picpopper_theme_color_v7_4'; 
    const STORAGE_KEY_COMMUNITIES = 'picpopper_user_communities_v7_4'; // NEW

    const postTextarea = document.getElementById('postText');
    const feed = document.getElementById('feed');
    const profilePostsFeed = document.getElementById('profilePostsFeed');
    const postModal = document.getElementById('postModal');
    const modalPostButton = document.getElementById('modalPostButton');
    const headerAvatar = document.getElementById('headerAvatar');
    const modalAvatar = document.getElementById('modalAvatar');
    const profilePageAvatar = document.getElementById('profilePageAvatar');
    const mainView = document.getElementById('mainView');
    const profileView = document.getElementById('profileView');
    const communitiesView = document.getElementById('communitiesView');
    const trendingView = document.getElementById('trendingView');
    const postDetailView = document.getElementById('postDetailView'); 
    const headerTabs = document.getElementById('headerTabs');
    const editProfileModal = document.getElementById('editProfileModal');
    const settingsModal = document.getElementById('settingsModal'); 
    const hashtagModal = document.getElementById('hashtagModal'); 
    const createCommunityModal = document.getElementById('createCommunityModal'); // NEW
    const createCommunityButton = document.getElementById('createCommunityButton'); // NEW
    const communityListDiv = document.getElementById('communityList'); // NEW
    const pfpInput = document.getElementById('pfpInput');

    let userPosts = [];
    let botPosts = [];
    let userCommunities = []; // NEW
    let currentTab = 'home';
    let currentProfileView = null; 
    let statUpdateInterval; 
    const UPDATE_INTERVAL_MS = 3000; 

    // Unified User Profile State
    let userProfile = {
        name: "YourName",
        handle: "@YourName",
        initial: "Y",
        followers: "455K",
        following: "22K",
        bio: 'This is your self-proclaimed bio. Edit your profile!',
        location: 'Simulator',
        joined: 'Today',
        pfp: null, 
        banner: '#1d9bf0', 
        themeColor: '#1d9bf0',
        // --- PREMIUM STATE ---
        isPremium: false, 
        premiumBadge: 'fas fa-star', 
        viewGrowthMultiplier: 1, 
        customTheme: null 
    };

    // --- Bot Data Definition (Removed demo communitiesData) ---
    const botData = [
        { id: 1000, name: 'CryptoWhale', handle: '@WhaleTrade', initial: 'C', color: '#ffd700', bio: 'I trade crypto and tweet nonsense. Not financial advice. Always FOMO.', location: 'Mars', joined: 'Oct 2021', followers: '850K', following: '120', pfp: null },
        { id: 1001, name: 'AI_Geek', handle: '@FutureMind', initial: 'A', color: '#00ccff', bio: 'Exploring the intersection of LLMs and human consciousness. Code is art.', location: 'San Francisco, CA', joined: 'Apr 2020', followers: '1.2M', following: '500', pfp: null },
        { id: 1002, name: 'FoodieBabe', handle: '@EatsLife', initial: 'F', color: '#ff69b4', bio: 'If it tastes good, I post it. Professional eater and amateur baker. 🍕', location: 'New York, NY', joined: 'Jan 2018', followers: '350K', following: '980', pfp: null },
        { id: 1003, name: 'TechNewsNow', handle: '@TechBuzz', initial: 'T', color: '#00ff00', bio: 'Breaking news in gadgets and innovation. If it plugs in, we cover it.', location: 'Global', joined: 'Nov 2022', followers: '2.1M', following: '15', pfp: null },
        { id: 1004, name: 'Minimalist_Z', handle: '@ZenLife', initial: 'Z', color: '#7b1fa2', bio: 'Less is more. Digital declutter advocate. Find peace in the void.', location: 'Kyoto, Japan', joined: 'Jun 2019', followers: '150K', following: '20', pfp: null },
    ];
    
    // Removed communitiesData based on user request ("remove demo communities")
    const adPosts = [
        {
            id: 9000,
            type: 'ad_premium',
            content: "Tired of slow growth? Unlock **3x faster** view counts and exclusive themes! Tap to activate Premium now.",
            timestamp: Date.now() - (3600 * 1000 * 5), 
            baseLikes: 500,
            baseReposts: 50,
            baseComments: 20,
            baseViews: 15000,
            adDetails: {
                name: 'PicPopper Premium',
                handle: '@PicPopper',
                initial: 'P',
                color: 'gold',
                actionButton: true,
                actionFunction: 'promptPremiumCode()'
            }
        },
    ];
    const genericHashtags = [ 'SimulatorLife', 'CodingIsFun', 'WebDev', 'TechTalk', 'FoodPorn', 'TravelGoals', 'DeepLearning', 'Gaming', 'Fitness', 'Art', 'Motivation', 'MondayMood' ];

    // --- Utility Functions ---
    function formatNumber(num) { 
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M'; 
        if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K'; 
        return Math.floor(num).toString(); 
    }
    
    function parseFollowers(followers) { 
        const f = followers.toUpperCase(); 
        if (f.includes('M')) return parseFloat(f.replace('M', '')) * 1000000; 
        if (f.includes('K')) return parseFloat(f.replace('K', '')) * 1000; 
        return parseInt(f) || 50; 
    }

    // NEW UTILITY: Parses K/M for community members and returns integer
    function parseCommunityMembers(membersString) {
        const s = membersString.toUpperCase().trim();
        if (s.includes('M')) return Math.floor(parseFloat(s.replace('M', '')) * 1000000); 
        if (s.includes('K')) return Math.floor(parseFloat(s.replace('K', '')) * 1000); 
        return parseInt(s) || 100;
    }
    
    function timeAgo(timestamp) { 
        const seconds = Math.floor((Date.now() - timestamp) / 1000); 
        let interval = seconds / 31536000; 
        if (interval > 1) return Math.floor(interval) + "y"; 
        interval = seconds / 2592000; 
        if (interval > 1) return Math.floor(interval) + "mo"; 
        interval = seconds / 86400; 
        if (interval > 1) return Math.floor(interval) + "d"; 
        interval = seconds / 3600; 
        if (interval > 1) return Math.floor(interval) + "h"; 
        interval = seconds / 60; 
        if (interval > 1) return Math.floor(interval) + "m"; 
        return Math.floor(seconds) + "s"; 
    } 
    
    function extractHashtags(text) { 
        const regex = /#(\w+)/g; 
        return (text.match(regex) || []).map(tag => tag.substring(1)); 
    } 
    
    function linkHashtags(text) { 
        const regex = /#(\w+)/g; 
        return text.replace(regex, (match, tag) => { 
            return `<a href="#" onclick="showHashtagPosts('${tag}'); return false;">#${tag}</a>`; 
        }); 
    } 

    // NEW FUNCTION: Calculates the base view boost factor (2M members -> 405K views per 5 min)
    function getCommunityViewBoostFactor() {
        if (userCommunities.length === 0) return 0;
        
        // Use the member count of the first community
        const memberCount = userCommunities[0].members; 
        
        // Formula: 286 * sqrt(Members). This is normalized for the required rate 
        // with diminishing returns (square root function).
        // Dividing the result by 10 (2860 * Math.random() / 10) in the real-time loop 
        // to approximate the 5-minute rate over the 3-second interval.
        return 286 * Math.sqrt(memberCount);
    }
    
    // --- Persistence and Time-Warp Logic ---
    // Theme Logic (remains unchanged)
    function applyTheme(color) { 
        document.documentElement.style.setProperty('--primary-color', color); 
        userProfile.themeColor = color; 
        localStorage.setItem(STORAGE_KEY_THEME, color); 
        document.getElementById('themeOptions')?.querySelectorAll('button').forEach(btn => { 
            btn.classList.remove('active'); 
            if (btn.getAttribute('data-color') === color) { 
                btn.classList.add('active'); 
            } 
        }); 
        if (profileView.style.display !== 'none' && currentProfileView === 'user') { 
            renderProfilePosts(); 
        } 
    } 
    
    // MODIFIED: Incorporate Community Boost into offline growth
    function calculateOfflineGrowth(post, timeElapsedHours) { 
        if (timeElapsedHours <= 0) return; 
        
        const growthFactor = Math.log10(timeElapsedHours + 1) * 0.5 + 1; 

        // Community View Boost Logic
        const communityBoostFactor = getCommunityViewBoostFactor();
        let communityViewBoost = 0;
        if (communityBoostFactor > 0) {
            // Apply a strong initial boost for long offline periods
            communityViewBoost = Math.floor(communityBoostFactor * growthFactor * timeElapsedHours * 0.05 * Math.random());
        }

        post.baseLikes = Math.floor(post.baseLikes + (timeElapsedHours * 5 * growthFactor * Math.random())); 
        post.baseReposts = Math.floor(post.baseReposts + (timeElapsedHours * 2 * growthFactor * Math.random())); 
        post.baseComments = Math.floor(post.baseComments + (timeElapsedHours * 1 * growthFactor * Math.random())); 
        
        // Apply Premium Multiplier + Community Boost
        const baseViewsGrowth = timeElapsedHours * 50 * growthFactor * Math.random() * userProfile.viewGrowthMultiplier;

        post.baseViews = Math.floor(post.baseViews + baseViewsGrowth + communityViewBoost);
    } 

    function loadData() { 
        // 0. Load Theme FIRST
        const storedTheme = localStorage.getItem(STORAGE_KEY_THEME); 
        if (storedTheme) { 
            userProfile.themeColor = storedTheme; 
        } 
        applyTheme(userProfile.themeColor); 

        const now = Date.now(); 
        const lastSessionTime = parseInt(localStorage.getItem(STORAGE_KEY_LAST_SESSION) || now); 
        const timeElapsedHours = (now - lastSessionTime) / (3600 * 1000); 

        // 1. Load Profile
        const storedProfile = JSON.parse(localStorage.getItem(STORAGE_KEY_PROFILE)); 
        if (storedProfile) { 
            userProfile = { 
                ...userProfile, 
                ...storedProfile, 
                themeColor: userProfile.themeColor, 
                isPremium: storedProfile.isPremium || false, 
                premiumBadge: storedProfile.premiumBadge || 'fas fa-star', 
                viewGrowthMultiplier: storedProfile.viewGrowthMultiplier || 1, 
                customTheme: storedProfile.customTheme || null 
            }; 
            // Simulate follower growth when user is offline 
            const currentFollowers = parseFollowers(userProfile.followers); 
            const newFollowers = currentFollowers + Math.floor(timeElapsedHours * 20 * Math.random() * (currentFollowers / 100000)); 
            userProfile.followers = formatNumber(newFollowers); 
        } 

        // 2. Load Communities (NEW)
        userCommunities = JSON.parse(localStorage.getItem(STORAGE_KEY_COMMUNITIES)) || [];

        // 3. Load and Grow User Posts
        userPosts = JSON.parse(localStorage.getItem(STORAGE_KEY_POSTS)) || []; 
        userPosts.forEach(post => calculateOfflineGrowth(post, timeElapsedHours)); 
        if (userPosts.length === 0) { 
            userPosts = [{ id: Date.now(), content: "Welcome to PicPopper! Your stats were updated based on the " + timeElapsedHours.toFixed(2) + " hours you were away. New posts start at 0! #PicPopperSim #Hello", timestamp: Date.now() - (3600 * 1000 * 48), baseLikes: 50, baseReposts: 10, baseComments: 5, baseViews: 500 }]; 
        } 

        // 4. Load and Grow Bot Posts
        botPosts = JSON.parse(localStorage.getItem(STORAGE_KEY_BOT_POSTS)); 
        if (!botPosts || botPosts.length === 0) { 
            botPosts = generateInitialBotPosts(); 
        } 
        // Only apply standard growth to bot posts, no community boost
        botPosts.forEach(post => { 
            const growthFactor = Math.log10(timeElapsedHours + 1) * 0.5 + 1;
            post.baseLikes = Math.floor(post.baseLikes + (timeElapsedHours * 5 * growthFactor * Math.random()));
            post.baseReposts = Math.floor(post.baseReposts + (timeElapsedHours * 2 * growthFactor * Math.random()));
            post.baseComments = Math.floor(post.baseComments + (timeElapsedHours * 1 * growthFactor * Math.random()));
            post.baseViews = Math.floor(post.baseViews + (timeElapsedHours * 50 * growthFactor * Math.random()));
        });

        // 5. Grow Ad Posts (Ad posts are static, so we only need to apply growth) 
        adPosts.forEach(post => calculateOfflineGrowth(post, timeElapsedHours)); 

        // 6. Update UI and start real-time updates 
        updateProfileUI(); 
        startStatUpdates(); 
    } 

    function saveData() { 
        localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(userPosts)); 
        localStorage.setItem(STORAGE_KEY_PROFILE, JSON.stringify(userProfile)); 
        localStorage.setItem(STORAGE_KEY_BOT_POSTS, JSON.stringify(botPosts)); 
        localStorage.setItem(STORAGE_KEY_LAST_SESSION, Date.now().toString()); 
        localStorage.setItem(STORAGE_KEY_COMMUNITIES, JSON.stringify(userCommunities)); // NEW
    } 

    // ADDED: Re-implementation of startStatUpdates with Community Boost Logic
    function startStatUpdates() {
        // Clear any existing interval to prevent duplicates
        if (statUpdateInterval) {
            clearInterval(statUpdateInterval);
        }

        // Calculate community boost factor once per interval setup
        const communityBoostFactor = getCommunityViewBoostFactor();

        statUpdateInterval = setInterval(() => {
            let needsRerender = false;

            // 1. Update Bot Posts (Standard growth)
            botPosts.forEach(post => {
                const growthRate = Math.max(1, parseFollowers(post.user.followers) / 100000);
                post.baseViews += Math.floor(Math.random() * 2 * growthRate);
                post.baseLikes += Math.floor(Math.random() * 0.5 * growthRate);
            });

            // 2. Update User Posts (With Premium and Community Boost)
            userPosts.forEach(post => {
                const followerFactor = parseFollowers(userProfile.followers) / 100000;
                
                // Base growth (follows/premium)
                let baseGrowthViews = Math.floor(Math.random() * 5 * followerFactor * userProfile.viewGrowthMultiplier);

                // Community View Boost Logic
                let effectiveCommunityBoost = 0;
                if (communityBoostFactor > 0) {
                    // Divide by 10 to normalize the 5-minute rate (405K) to the 3-second interval (approx 4K)
                    effectiveCommunityBoost = Math.floor(communityBoostFactor * Math.random() / 10); 
                }
                
                // Apply updates
                const oldViews = post.baseViews;
                post.baseViews += baseGrowthViews + effectiveCommunityBoost;
                
                if (post.baseViews !== oldViews && currentTab === 'home') {
                    needsRerender = true;
                }

                post.baseLikes += Math.floor(Math.random() * 2 * followerFactor);
                post.baseReposts += Math.floor(Math.random() * 1 * followerFactor);
                post.baseComments += Math.floor(Math.random() * 0.5 * followerFactor);

                // If on user profile, update individual post stats
                if (currentProfileView === 'user') {
                    const postElement = document.getElementById(`post-${post.id}`);
                    if (postElement) {
                        renderPostStats(postElement, post);
                    }
                }
            });

            // 3. Update Ad Posts (Minimal, static growth)
            adPosts.forEach(post => {
                post.baseViews += Math.floor(Math.random() * 10); 
            });

            // Re-render the feed if necessary (e.g., when on the home tab)
            if (needsRerender && (currentTab === 'home' || currentTab === 'trending')) {
                 // Optimization: Only re-render if the user is currently viewing the feed
                 renderFeed(); 
            }
            
            // Re-render profile if needed (for post count and stats)
            if (currentProfileView === 'user') {
                 updateProfileUI(); // Updates follower count
            }


            // Save data every minute (20 intervals * 3 seconds)
            if (Math.floor(Date.now() / UPDATE_INTERVAL_MS) % 20 === 0) {
                saveData();
            }

        }, UPDATE_INTERVAL_MS);
    }
    // END startStatUpdates

    // ... (rest of functions, mostly unchanged)

    function renderCommunities() {
        switchView('communities');
        communityListDiv.innerHTML = '';
        
        if (userCommunities.length === 0) {
            // Show the "Create" prompt
            communityListDiv.innerHTML = `
                <div class="create-community-prompt">
                    <i class="fas fa-users" style="font-size: 50px; color: var(--x-dim-text); margin-bottom: 15px;"></i>
                    <h3>No Communities Found</h3>
                    <p style="color: var(--x-dim-text);">
                        Create your own community to instantly gain a huge view boost on your posts!
                    </p>
                    <button class="follow-button theme-bg-dynamic" style="width: 80%; max-width: 300px; margin-top: 15px;" onclick="openCreateCommunityModal()">
                        <i class="fas fa-plus" style="margin-right: 5px;"></i> Create Community
                    </button>
                </div>
            `;
        } else {
            // List user-created communities
            userCommunities.forEach(community => {
                const iconStyle = community.banner.includes('#') || community.banner.includes('gradient') ? `background: ${community.banner};` : `background-image: url('${community.banner}'); background-size: cover;`;
                
                communityListDiv.innerHTML += `
                    <div class="community-item">
                        <div class="community-icon" style="${iconStyle}">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        <div class="community-details">
                            <strong style="font-size: 16px;">${community.title}</strong>
                            <div class="members">
                                <i class="fas fa-user-group" style="margin-right: 3px;"></i>${formatNumber(community.members)} members
                            </div>
                        </div>
                    </div>
                `;
            });
            // Add a permanent "Create" button at the bottom if the user wants more
            communityListDiv.innerHTML += `
                <div style="padding: 15px 0; text-align: center; border-top: 1px solid var(--x-border); margin-top: 15px;">
                    <button class="follow-button theme-bg-dynamic" style="background-color: var(--x-light-gray); color: var(--primary-color); border: 1px solid var(--primary-color); width: 80%; max-width: 300px;" onclick="openCreateCommunityModal()">
                        <i class="fas fa-plus" style="margin-right: 5px;"></i> Create Another Community
                    </button>
                </div>
            `;
        }
    }

    function checkCommunityInputs() {
        const title = document.getElementById('communityTitle').value.trim();
        const members = document.getElementById('communityMembers').value.trim();
        
        // Basic validation: title and members cannot be empty.
        createCommunityButton.disabled = title === "" || members === "";
    }

    function openCreateCommunityModal() {
        // Reset inputs and check button state
        document.getElementById('communityTitle').value = '';
        document.getElementById('communityBanner').value = '';
        document.getElementById('communityMembers').value = '';
        checkCommunityInputs();

        createCommunityModal.style.display = 'flex';
    }

    function closeCreateCommunityModal() {
        createCommunityModal.style.display = 'none';
    }

    function createCommunity() {
        const title = document.getElementById('communityTitle').value.trim();
        const banner = document.getElementById('communityBanner').value.trim() || 'linear-gradient(135deg, #1d9bf0, #8000ff)'; // Default gradient
        const membersRaw = document.getElementById('communityMembers').value.trim();
        
        if (!title || !membersRaw) return;

        const memberCount = parseCommunityMembers(membersRaw);

        const newCommunity = {
            id: Date.now(),
            title: title,
            banner: banner,
            members: memberCount,
            creationDate: Date.now()
        };

        userCommunities.push(newCommunity);
        
        // 1. Apply the "big following boost"
        const currentFollowers = parseFollowers(userProfile.followers);
        // Add 10% of the community members as a one-time follower boost, capped at 1M
        const followerBoost = Math.min(1000000, Math.floor(memberCount * 0.1)); 
        userProfile.followers = formatNumber(currentFollowers + followerBoost);

        // 2. Save data, close modal, and re-render
        saveData();
        closeCreateCommunityModal();
        updateProfileUI(); // Update profile to show new follower count
        
        // Restart the stat updates to pick up the new community boost factor
        startStatUpdates(); 
        
        // Go back to communities view
        switchTab('communities'); 
    }

    // ... (All other existing functions are assumed to be present here)
    // ... (such as switchView, renderPost, etc.)

    function switchTab(tabName, navItem = null) {
        // This is the core navigation logic, must be modified to include the new tab logic.

        // Hide all main view containers
        mainView.style.display = 'none';
        trendingView.style.display = 'none';
        communitiesView.style.display = 'none';
        profileView.style.display = 'none';
        postDetailView.style.display = 'none';

        // Remove active class from all bottom nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });

        // Set the new active tab
        currentTab = tabName;

        if (navItem) {
            navItem.classList.add('active');
        } else {
            // This handles internal tab switching (like logo click)
            const internalNavItem = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (internalNavItem) {
                internalNavItem.classList.add('active');
            }
        }
        
        // Hide the main tabs if viewing a sub-screen like profile or post detail
        headerTabs.style.display = (tabName === 'home' || tabName === 'trending') ? 'flex' : 'none';

        if (tabName === 'home') {
            mainView.style.display = 'block';
            renderFeed();
        } else if (tabName === 'communities') {
            communitiesView.style.display = 'block';
            renderCommunities(); // NEW: Call the community renderer
        } else if (tabName === 'trending') {
            trendingView.style.display = 'block';
            renderTrending();
        } else if (tabName === 'notifications') {
            switchView('main');
            feed.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--x-dim-text);">Notifications are quiet... for now.</div>';
        } else if (tabName === 'settings') {
            // Note: This tab is opened via openSettingsModal in the main nav, 
            // but this path handles cases like deep linking/internal calls.
            openSettingsModal(document.querySelector('.nav-item[data-tab="settings"]'));
        } else {
            // Default to home
            switchTab('home');
        }
        
        // If the view is not profile, reset currentProfileView
        if (tabName !== 'profile' && tabName !== 'postDetail') {
            currentProfileView = null;
        }
        
        // Handle header logo/tabs for home/trending views
        if (tabName === 'home' || tabName === 'trending') {
             // Logic to update header tabs to reflect the current main tab
             document.querySelectorAll('.header-tabs.main-view-tabs .tab-item').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                }
             });
        }
        
        // Always save the current view state
        saveData();
    }
    
    // ... (rest of functions, mostly unchanged)

    function generateInitialBotPosts() { 
        let posts = []; 
        botData.forEach(bot => { 
            const numPosts = Math.floor(Math.random() * 3) + 1; 
            for (let i = 0; i < numPosts; i++) { 
                const ageHours = Math.floor(Math.random() * 72) + 1; 
                const base = parseFollowers(bot.followers); 
                const content = [ 
                    "Just solved a major bug that was eating my weekend. Time for celebratory coffee. ☕ #CodingIsFun", 
                    "What's the best framework for a mobile simulator? Asking for a friend. 😉 #WebDev", 
                    "Unpopular opinion: Pineapple on pizza is *fine*. Don't @ me. #FoodPorn", 
                    "If you're not failing, you're not trying hard enough. Keep building! #Motivation", 
                    "My favorite color is #..." 
                ]; // Truncated placeholder for brevity

                posts.push({ 
                    id: Date.now() + Math.random(), 
                    content: content[i % content.length] + ' #' + genericHashtags[Math.floor(Math.random() * genericHashtags.length)],
                    timestamp: Date.now() - (3600 * 1000 * ageHours), 
                    baseLikes: Math.floor(Math.random() * base / 1000), 
                    baseReposts: Math.floor(Math.random() * base / 5000), 
                    baseComments: Math.floor(Math.random() * base / 10000), 
                    baseViews: Math.floor(Math.random() * base * 50 * (ageHours / 24)), 
                    user: bot 
                }); 
            } 
        }); 
        return posts.sort((a, b) => b.timestamp - a.timestamp); 
    }

    // --- Post/Modal Logic ---

    function checkPostLength() {
        modalPostButton.disabled = postTextarea.value.trim() === "";
    }

    function openPostModal() {
        postModal.style.display = 'flex';
        checkPostLength();
    }

    function closePostModal() {
        postModal.style.display = 'none';
        postTextarea.value = '';
    }

    function postTweet() {
        const content = postTextarea.value.trim();
        if (content === "") return;

        const newPost = {
            id: Date.now(),
            content: content,
            timestamp: Date.now(),
            baseLikes: 0,
            baseReposts: 0,
            baseComments: 0,
            baseViews: 0
        };

        userPosts.unshift(newPost); // Add to the start
        
        // Update post count immediately, triggering animation
        updateAnimatedStat('profilePostCount', userPosts.length);

        // FIX: Close modal and switch to home tab, which will trigger a full feed re-render.
        closePostModal();
        switchTab('home'); 
    }


    // --- Initialization ---

    // Function placeholders must be present before loadData is called.
    function renderFeed() {} // Dummy placeholders for missing functions
    function switchView() {}
    function renderTrending() {}
    function updateProfileUI() {}
    function renderPostStats() {}
    function updateAnimatedStat() {}
    function openSettingsModal() {}
    function saveProfileChanges() {}
    function closeSettingsModal() {}
    function openPremiumModal() {}
    function closePremiumModal() {}
    function promptPremiumCode() {}
    function closeHashtagModal() {}
    function showHashtagPosts() {}
    function closeEditProfileModal() {}
    function openEditProfileModal() {}
    function showProfile() {}


    loadData();

</script>

</body>
</html>