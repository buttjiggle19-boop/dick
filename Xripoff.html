<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PicPopper Mobile Simulator v7.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* CSS Variables for Modern X/Twitter Mobile Theme */
        :root {
            --primary-blue: #1d9bf0; 
            --primary-purple: #8000ff; /* New theme color */
            --x-dark: #000000;
            --x-light-gray: #16181c; 
            --x-text-color: #e7e9ea;
            --x-dim-text: #71767b; 
            --x-border: #2f3336;
        }

        /* --- Theme-Specific Styles --- */
        /* This dynamic block will be controlled by JavaScript */
        .theme-color-dynamic {
            color: var(--primary-color);
        }
        .theme-bg-dynamic {
            background-color: var(--primary-color);
        }
        .tab-item.active::after {
            background-color: var(--primary-color);
        }
        .header-logo {
            color: var(--primary-color); /* Updated for theme */
        }
        .avatar {
            background-color: var(--primary-color); /* Updated for theme */
        }
        .verified-badge {
            color: var(--primary-color); /* Updated for theme */
        }
        .fab-post {
            background-color: var(--primary-color); /* Updated for theme */
        }
        .nav-item.active {
            color: var(--primary-color); /* Updated for theme */
        }
        .modal-header button {
            background-color: var(--primary-color); /* Updated for theme */
        }
        .modal-header button:disabled {
            background-color: color-mix(in srgb, var(--primary-color) 70%, var(--x-dark));
            opacity: 0.7;
        }
        .edit-form-group label {
            color: var(--primary-color);
        }

        /* Base Body and Container Setup */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--x-dark);
            color: var(--x-text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 0;
            overflow-x: hidden;
            height: 100vh;
        }

        .simulator-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--x-dark);
            min-height: 100vh;
            position: relative;
            /* Space for sticky header (55px) and footer (55px) */
            padding-top: 55px; 
            padding-bottom: 55px; 
            box-sizing: border-box;
        }

        /* ---------------------------------- */
        /* 1. HEADER & NAVIGATION             */
        /* ---------------------------------- */
        .header-container {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 600px;
            background-color: var(--x-dark);
            z-index: 1000;
            border-bottom: 1px solid var(--x-border);
        }
        
        .top-header {
            height: 55px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        
        .header-logo {
            font-size: 20px;
            font-weight: 900;
            cursor: pointer; 
        }
        
        .header-logo i {
            margin-right: 5px;
        }
        
        .header .icon {
             font-size: 20px;
             color: var(--x-text-color);
        }

        /* Avatar Styling (Updated for PFP image support) */
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
            flex-shrink: 0; 
            /* Added for PFP image */
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }
        .avatar:active { transform: scale(0.9); }
        
        .header-tabs {
            display: flex;
            justify-content: space-around;
            height: 50px;
            border-bottom: 1px solid var(--x-border);
        }

        .tab-item {
            padding: 0 10px;
            color: var(--x-dim-text);
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .tab-item.active {
            color: var(--x-text-color);
        }
        
        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 4px;
            border-radius: 2px;
            animation: tabUnderline 0.3s ease-out;
        }
        
        /* ---------------------------------- */
        /* 2. POST DISPLAY & ANIMATION        */
        /* ---------------------------------- */
        .feed {
            min-height: 500px; 
        }

        .post {
            padding: 15px;
            border-bottom: 1px solid var(--x-border);
            display: flex;
            animation: fadeIn 0.3s ease-in-out;
            cursor: pointer; /* Added for clicking on posts */
        }

        .post-body {
            flex-grow: 1;
            padding-left: 10px;
        }
        
        /* Verified Badge and Post Header Layout */
        .post-header-info {
            display: flex;
            align-items: center;
        }
        
        /* Stat Update Animation */
        .stat-animated {
            animation: statPulse 0.5s ease-out;
        }
        
        @keyframes statPulse {
            0% { color: var(--primary-color); transform: scale(1); }
            50% { color: var(--primary-color); transform: scale(1.1); }
            100% { color: var(--x-dim-text); transform: scale(1); }
        }

        /* --- POST ACTIONS FIX --- */
        .post-actions {
            display: flex;
            /* Changed from space-between to flex-start to allow the share button to be pushed to the right */
            justify-content: flex-start;
            gap: 20px; /* Spacing between the first four actions */
            margin-top: 15px;
            color: var(--x-dim-text);
            font-size: 13px;
            max-width: 450px;
        }

        .action-item {
            display: flex;
            align-items: center;
            gap: 5px; /* Spacing between icon and count */
            cursor: pointer;
            padding: 5px 0;
        }
        
        .post-actions .share {
            margin-left: auto; /* Pushes the share icon to the far right */
            gap: 0; /* Share button doesn't have a count */
        }

        /* ---------------------------------- */
        /* 2b. POST DETAIL VIEW               */
        /* ---------------------------------- */
        #postDetailView {
            display: none;
            position: relative;
        }
        .post-detail-header {
            position: sticky;
            top: 55px;
            z-index: 999;
            background-color: var(--x-dark);
            border-bottom: 1px solid var(--x-border);
            padding: 10px 15px;
        }
        .post-detail-header i {
            font-size: 20px;
            cursor: pointer;
        }
        .post-detail-post-container {
            padding: 15px;
            border-bottom: 1px solid var(--x-border);
        }
        .post-detail-post-container .post-body {
            padding-left: 0; 
        }
        .post-detail-post-container .post-header-info {
            margin-bottom: 10px;
        }
        .post-detail-post-container .avatar {
            width: 48px;
            height: 48px;
            font-size: 20px;
        }
        .post-detail-content {
            font-size: 18px;
            line-height: 1.4;
            margin-bottom: 15px;
        }
        .post-detail-timestamp {
            color: var(--x-dim-text);
            font-size: 14px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--x-border);
        }
        .post-detail-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--x-border);
        }
        .post-detail-stats strong {
            color: var(--x-text-color);
            margin-right: 5px;
        }
        /* Detail actions need to be spread out again since they don't have counts */
        .post-detail-actions {
            justify-content: space-around !important;
            max-width: 100% !important;
        }
        .comments-section {
            padding: 15px;
            text-align: center;
            color: var(--x-dim-text);
        }

        /* ---------------------------------- */
        /* 3. PROFILE PAGE VIEW               */
        /* ---------------------------------- */
        #profileView {
            display: none;
            padding: 0;
        }
        
        .profile-content-scroll {
             height: 100%;
             overflow-y: auto;
             -webkit-overflow-scrolling: touch;
        }

        .profile-header-container {
            position: relative;
            background-color: var(--x-dark);
            padding-top: 55px; /* Space for the fixed header */
        }

        .banner {
            width: 100%;
            height: 150px;
            /* Banner will get its background from JS/userProfile.banner */
            background: linear-gradient(135deg, var(--primary-color), #333); 
        }

        .profile-details {
            padding: 0 15px 15px 15px;
            margin-top: -60px;
        }

        .profile-page-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--x-dark);
            font-size: 30px;
            margin-bottom: 10px;
        }

        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 15px;
        }

        .stat-item {
            color: var(--x-dim-text);
        }
        .stat-item strong {
            color: var(--x-text-color);
            margin-right: 5px;
            transition: color 0.5s, transform 0.5s; /* Ensure strong is part of animation */
        }
        
        .follow-button, #editProfileButton {
            float: right;
            background-color: var(--x-text-color);
            color: var(--x-dark);
            border: none;
            padding: 8px 18px;
            border-radius: 9999px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -30px;
            transition: background-color 0.2s;
        }
        #editProfileButton {
            background-color: var(--x-dark);
            color: var(--x-text-color);
            border: 1px solid var(--x-border);
        }
        
        /* ---------------------------------- */
        /* 4. MODAL STYLING (Post & Edit)     */
        /* ---------------------------------- */
        #postModal, #editProfileModal, #settingsModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--x-dark); 
            z-index: 2000;
            justify-content: center;
            align-items: flex-start;
        }

        .modal-content {
            width: 100%;
            max-width: 600px;
            background-color: var(--x-dark);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--x-border);
            padding: 10px 15px;
            flex-shrink: 0;
        }
        
        .modal-header .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--x-text-color);
            padding: 5px;
        }
        
        /* Settings List Styles */
        .settings-list {
            padding: 15px;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--x-border);
            cursor: pointer;
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .theme-options button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--x-border);
            margin-left: 5px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .theme-options button.active {
            border-color: var(--x-text-color);
            border-width: 4px;
        }
        
        /* ---------------------------------- */
        /* 5. COMMUNITIES VIEW                */
        /* ---------------------------------- */
        #communitiesView {
            display: none;
        }
        .community-list {
            padding: 15px;
        }
        .community-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--x-border);
            cursor: pointer;
        }
        .community-item:last-child {
            border-bottom: none;
        }
        .community-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }
        .community-details {
            margin-left: 15px;
        }
        .community-details .members {
            color: var(--x-dim-text);
            font-size: 14px;
        }
        
        /* ---------------------------------- */
        /* 6. OTHER STYLES (Bottom Nav, FAB)  */
        /* ---------------------------------- */

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px;
            height: 55px;
            background-color: var(--x-dark);
            border-top: 1px solid var(--x-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        .nav-item {
            color: var(--x-dim-text);
            font-size: 22px;
            padding: 10px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .fab-post {
            position: fixed;
            bottom: 70px;
            right: 15px;
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            z-index: 1001;
            right: calc(50% - 300px + 15px);
        }
        
        @media (max-width: 600px) {
            .fab-post {
                right: 15px;
            }
        }
    </style>
</head>
<body>

<div class="simulator-container">

    <div class="header-container" id="headerContainer">
        <div class="top-header">
            <div class="avatar" id="headerAvatar" onclick="showProfile('user')">Y</div>
            <div class="header-logo" onclick="switchTab('home')"><i class="fas fa-camera"></i>PicPopper</div>
            <i class="far fa-bell icon" onclick="switchTab('notifications')"></i>
        </div>
        <div class="header-tabs main-view-tabs" id="headerTabs">
            <div class="tab-item active" data-tab="home" onclick="switchTab('home')">For You</div>
            <div class="tab-item" data-tab="search" onclick="switchTab('search')">Trending</div>
        </div>
    </div>
    
    <div id="mainView" style="display: block;">
        <div class="feed" id="feed"></div>
    </div>
    
    <div id="communitiesView" style="display: none; padding-top: 5px;">
        <div class="community-list" id="communityList">
            </div>
    </div>

    <div id="postDetailView" style="display: none;">
        <div class="post-detail-header">
            <i class="fas fa-arrow-left icon" onclick="switchTab(document.getElementById('postDetailView').getAttribute('data-previous-tab') || 'home')"></i>
        </div>
        <div id="postDetailContent">
            </div>
    </div>

    <div id="profileView" style="display: none;">
        <div class="profile-header-container">
            <div class="top-header" style="position: absolute; width: 100%; max-width: 600px; padding: 0 10px; background: none; border-bottom: none;">
                <i class="fas fa-arrow-left icon" onclick="switchTab('home')" style="cursor:pointer; background: rgba(0,0,0,0.5); padding: 5px 8px; border-radius: 50%; color: white;"></i>
                <i class="fas fa-ellipsis-v icon" style="background: rgba(0,0,0,0.5); padding: 5px 8px; border-radius: 50%; color: white;"></i>
            </div>
            
            <div class="profile-content-scroll" style="height: calc(100vh - 55px);">

                <div class="banner" id="profileBanner"></div>
                <div class="profile-details">
                    <button class="follow-button" id="editProfileButton" onclick="openEditProfileModal()">Edit Profile</button>
                    <button class="follow-button" id="followButton" style="display: none;">Follow</button>
                    
                    <div class="avatar profile-page-avatar" id="profilePageAvatar">Y</div>
                    
                    <h2 style="margin: 0; display: flex; align-items: center;" id="profileDisplayNameContainer">
                        <span id="profileDisplayName"></span>
                        <i class="fas fa-certificate verified-badge"></i>
                    </h2>
                    <span style="color: var(--x-dim-text);" id="profileHandle"></span>
                    
                    <p class="profile-bio" id="profileBio"></p>
                    
                    <div class="profile-location"><i class="fas fa-location-dot"></i><span id="profileLocation"></span></div>
                    <div class="profile-joined"><i class="fas fa-calendar-alt"></i>Joined <span id="profileJoined"></span></div>

                    <div class="profile-stats">
                        <div class="stat-item"><strong id="profilePostCount">0</strong> Posts</div>
                        <div class="stat-item"><strong id="profileFollowingCount">0</strong> Following</div>
                        <div class="stat-item"><strong id="profileFollowerCount">0</strong> Followers</div>
                    </div>
                </div>
                
                <div class="header-tabs">
                    <div class="tab-item active">Posts</div>
                    <div class="tab-item">Likes (Simulated)</div>
                </div>
                
                <div id="profilePostsFeed" class="feed"></div>
            </div>
        </div>
    </div>

    <div class="fab-post theme-bg-dynamic" onclick="openPostModal()">
        <i class="fas fa-plus"></i>
    </div>

    <div class="bottom-nav" id="bottomNav">
        <div class="nav-item active" data-tab="home" onclick="switchTab('home', this)"><i class="fas fa-house"></i></div>
        <div class="nav-item" data-tab="search" onclick="switchTab('search', this)"><i class="fas fa-magnifying-glass"></i></div>
        <div class="nav-item" data-tab="communities" onclick="switchTab('communities', this)"><i class="fas fa-users"></i></div>
        <div class="nav-item" data-tab="notifications" onclick="switchTab('notifications', this)"><i class="far fa-bell"></i></div>
        <div class="nav-item" data-tab="settings" onclick="openSettingsModal(this)"><i class="fas fa-gear"></i></div> </div>
    
</div>

<div id="postModal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closePostModal()"><i class="fas fa-times"></i></span>
            <button id="modalPostButton" onclick="postTweet()" disabled>Post</button>
        </div>
        <div class="modal-post-area" style="display: flex; padding: 15px;">
            <div class="avatar" id="modalAvatar">Y</div>
            <textarea id="postText" class="modal-textarea" placeholder="What's popping?" oninput="checkPostLength()" style="flex-grow: 1; margin-left: 10px; background: transparent; border: none; color: var(--x-text-color); font-size: 20px; outline: none; resize: none;"></textarea>
        </div>
        <div class="modal-footer" style="padding: 10px 15px; border-top: 1px solid var(--x-border); margin-top: auto; display: flex; justify-content: space-between;">
            <div>
                <i class="far fa-image icon" style="margin-right: 15px;"></i>
                <i class="fas fa-bars-staggered icon" style="margin-right: 15px;"></i>
                <i class="far fa-face-smile icon"></i>
            </div>
        </div>
    </div>
</div>

<div id="editProfileModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closeEditProfileModal()"><i class="fas fa-times"></i></span>
            <h3 style="margin:0; font-weight: bold;">Edit Profile</h3>
            <button onclick="saveProfileChanges()">Save</button>
        </div>
        <div style="padding: 15px; overflow-y: auto;">
            <div class="banner" id="editBanner" style="height: 100px; margin-bottom: -50px; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('pfpInput').click()">
                </div>
            
            <div class="avatar profile-page-avatar" id="editProfileAvatar" style="cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('pfpInput').click()">Y</div>
            <input type="file" id="pfpInput" accept="image/*" style="display: none;">
            
            <p style="color: var(--x-dim-text); font-size: 14px; margin-top: 10px;">Click the avatar or banner to change your profile picture.</p>

            <div class="edit-form-group">
                <label for="editDisplayName">Name</label>
                <input type="text" id="editDisplayName" maxlength="15">
            </div>
            <div class="edit-form-group">
                <label for="editFollowers">Followers (for growth demo)</label>
                <input type="text" id="editFollowers" maxlength="10">
            </div>
            <div class="edit-form-group">
                <label for="editBio">Bio</label>
                <textarea id="editBio" maxlength="160"></textarea>
            </div>
            <div class="edit-form-group">
                <label for="editLocation">Location</label>
                <input type="text" id="editLocation" maxlength="30">
            </div>
            <div class="edit-form-group">
                <label for="editJoined">Joined Date (e.g., Nov 2023)</label>
                <input type="text" id="editJoined" maxlength="30">
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closeSettingsModal()"><i class="fas fa-arrow-left"></i></span>
            <h3 style="margin:0; font-weight: bold;">Settings</h3>
            <div></div> </div>
        <div class="settings-list">
            <div class="setting-item">
                <span style="font-weight: bold;">Theme Color</span>
                <div class="theme-options" id="themeOptions">
                    <button style="background-color: #1d9bf0;" data-color="#1d9bf0" onclick="applyTheme('#1d9bf0')"></button>
                    <button style="background-color: #8000ff;" data-color="#8000ff" onclick="applyTheme('#8000ff')"></button>
                    <button style="background-color: #00ff00;" data-color="#00ff00" onclick="applyTheme('#00ff00')"></button>
                </div>
            </div>
            <div class="setting-item" onclick="alert('Display settings coming soon!')">
                <span style="font-weight: bold;">Display and language</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="setting-item" onclick="alert('Privacy settings coming soon!')">
                <span style="font-weight: bold;">Privacy and safety</span>
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Global Variables and Constants ---
    const STORAGE_KEY_POSTS = 'picpopper_user_posts_v7';
    const STORAGE_KEY_PROFILE = 'picpopper_user_profile_v7'; 
    const STORAGE_KEY_BOT_POSTS = 'picpopper_bot_posts_v7';
    const STORAGE_KEY_LAST_SESSION = 'picpopper_last_session_v7';
    const STORAGE_KEY_THEME = 'picpopper_theme_color_v7'; 
    
    const postTextarea = document.getElementById('postText');
    const feed = document.getElementById('feed');
    const profilePostsFeed = document.getElementById('profilePostsFeed');
    const postModal = document.getElementById('postModal');
    const modalPostButton = document.getElementById('modalPostButton');
    const headerAvatar = document.getElementById('headerAvatar');
    const modalAvatar = document.getElementById('modalAvatar');
    const profilePageAvatar = document.getElementById('profilePageAvatar');
    const mainView = document.getElementById('mainView');
    const profileView = document.getElementById('profileView');
    const communitiesView = document.getElementById('communitiesView');
    const postDetailView = document.getElementById('postDetailView'); 
    const headerTabs = document.getElementById('headerTabs');
    const editProfileModal = document.getElementById('editProfileModal');
    const settingsModal = document.getElementById('settingsModal'); 
    const pfpInput = document.getElementById('pfpInput');

    let userPosts = [];
    let botPosts = [];
    let currentTab = 'home';
    let currentProfileView = null; 
    let statUpdateInterval; 
    const UPDATE_INTERVAL_MS = 3000; 

    // Unified User Profile State
    let userProfile = {
        name: "YourName",
        handle: "@YourName",
        initial: "Y",
        followers: "455K",
        following: "22K",
        bio: 'This is your self-proclaimed bio. Edit your profile!',
        location: 'Simulator',
        joined: 'Today',
        pfp: null, 
        banner: '#1d9bf0', 
        themeColor: '#1d9bf0' 
    };

    // --- Bot and Communities Data Definition ---
    const botData = [
        { id: 1000, name: 'CryptoWhale', handle: '@WhaleTrade', initial: 'C', color: '#ffd700', bio: 'I trade crypto and tweet nonsense. Not financial advice. Always FOMO.', location: 'Mars', joined: 'Oct 2021', followers: '850K', following: '120', pfp: null },
        { id: 1001, name: 'AI_Geek', handle: '@FutureMind', initial: 'A', color: '#00ccff', bio: 'Exploring the intersection of LLMs and human consciousness. Code is art.', location: 'San Francisco, CA', joined: 'Apr 2020', followers: '1.2M', following: '500', pfp: null },
        { id: 1002, name: 'FoodieBabe', handle: '@EatsLife', initial: 'F', color: '#ff69b4', bio: 'If it tastes good, I post it. Professional eater and amateur baker. 🍕', location: 'New York, NY', joined: 'Jan 2018', followers: '350K', following: '980', pfp: null },
        { id: 1003, name: 'TechNewsNow', handle: '@TechBuzz', initial: 'T', color: '#00ff00', bio: 'Breaking news in gadgets and innovation. If it plugs in, we cover it.', location: 'Global', joined: 'Nov 2022', followers: '2.1M', following: '15', pfp: null },
        { id: 1004, name: 'Minimalist_Z', handle: '@ZenLife', initial: 'Z', color: '#7b1fa2', bio: 'Less is more. Digital declutter advocate. Find peace in the void.', location: 'Kyoto, Japan', joined: 'Jun 2019', followers: '150K', following: '20', pfp: null },
    ];
    
    const communitiesData = [
        { name: 'Crypto Trading Hub', handle: '#CryptoTrade', members: '8.1M', color: '#ffd700', icon: 'fas fa-dollar-sign' },
        { name: 'AI/ML Enthusiasts', handle: '#MachineLearning', members: '6.5M', color: '#00ccff', icon: 'fas fa-microchip' },
        { name: 'Global Food Critics', handle: '#EatsLife', members: '4.9M', color: '#ff69b4', icon: 'fas fa-utensils' },
        { name: 'Tech News Digest', handle: '#TechBuzz', members: '7.2M', color: '#00ff00', icon: 'fas fa-newspaper' },
        { name: 'Retro Gaming', handle: '#PixelPerfect', members: '5.4M', color: '#8888ff', icon: 'fas fa-gamepad' },
    ];

    // --- Utility Functions ---

    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
        return Math.floor(num).toString();
    }
    
    function parseFollowers(followers) {
        const f = followers.toUpperCase();
        if (f.includes('M')) return parseFloat(f.replace('M', '')) * 1000000;
        if (f.includes('K')) return parseFloat(f.replace('K', '')) * 1000;
        return parseInt(f) || 50;
    }

    function timeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "y";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "mo";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "d";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "h";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "m";
        return Math.floor(seconds) + "s";
    }

    // --- Persistence and Time-Warp Logic ---
    
    // Theme Logic
    function applyTheme(color) {
        document.documentElement.style.setProperty('--primary-color', color);
        userProfile.themeColor = color;
        localStorage.setItem(STORAGE_KEY_THEME, color);

        // Update active state in settings modal
        document.getElementById('themeOptions')?.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-color') === color) {
                btn.classList.add('active');
            }
        });
        
        // Re-render anything necessary (like banner in case it uses a gradient with the theme color)
        if (profileView.style.display !== 'none' && currentProfileView === 'user') {
            renderProfilePosts();
        }
    }

    function calculateOfflineGrowth(post, timeElapsedHours) {
        if (timeElapsedHours <= 0) return;

        const growthFactor = Math.log10(timeElapsedHours + 1) * 0.5 + 1; 

        post.baseLikes = Math.floor(post.baseLikes + (timeElapsedHours * 5 * growthFactor * Math.random()));
        post.baseReposts = Math.floor(post.baseReposts + (timeElapsedHours * 2 * growthFactor * Math.random()));
        post.baseComments = Math.floor(post.baseComments + (timeElapsedHours * 1 * growthFactor * Math.random()));
        post.baseViews = Math.floor(post.baseViews + (timeElapsedHours * 50 * growthFactor * Math.random()));
    }

    function loadData() {
        // 0. Load Theme FIRST
        const storedTheme = localStorage.getItem(STORAGE_KEY_THEME);
        if (storedTheme) {
            userProfile.themeColor = storedTheme;
        }
        applyTheme(userProfile.themeColor); 
        
        const now = Date.now();
        const lastSessionTime = parseInt(localStorage.getItem(STORAGE_KEY_LAST_SESSION) || now);
        const timeElapsedHours = (now - lastSessionTime) / (3600 * 1000); 

        // 1. Load Profile
        const storedProfile = JSON.parse(localStorage.getItem(STORAGE_KEY_PROFILE));
        if (storedProfile) {
            userProfile = {...userProfile, ...storedProfile, themeColor: userProfile.themeColor}; // Ensure theme is preserved
            // Simulate follower growth when user is offline
            const currentFollowers = parseFollowers(userProfile.followers);
            const newFollowers = currentFollowers + Math.floor(timeElapsedHours * 20 * Math.random() * (currentFollowers / 100000));
            userProfile.followers = formatNumber(newFollowers);
        }

        // 2. Load and Grow User Posts
        userPosts = JSON.parse(localStorage.getItem(STORAGE_KEY_POSTS)) || [];
        userPosts.forEach(post => calculateOfflineGrowth(post, timeElapsedHours));
        
        if (userPosts.length === 0) {
            userPosts = [{
                id: Date.now(),
                content: "Welcome to PicPopper! Your stats were updated based on the " + timeElapsedHours.toFixed(2) + " hours you were away. New posts start at 0!",
                timestamp: Date.now() - (3600 * 1000 * 48), 
                baseLikes: 50,
                baseReposts: 10,
                baseComments: 5,
                baseViews: 500
            }];
        }

        // 3. Load and Grow Bot Posts
        botPosts = JSON.parse(localStorage.getItem(STORAGE_KEY_BOT_POSTS));
        if (!botPosts || botPosts.length === 0) {
            botPosts = generateInitialBotPosts();
        }
        botPosts.forEach(post => calculateOfflineGrowth(post, timeElapsedHours));
        
        // 4. Update UI and start real-time updates
        updateProfileUI();
        startStatUpdates();
    }

    function generateInitialBotPosts() {
        let posts = [];
        botData.forEach(bot => {
            const numPosts = Math.floor(Math.random() * 3) + 1; 
            for (let i = 0; i < numPosts; i++) {
                const ageHours = Math.floor(Math.random() * 72) + 1; 
                const base = parseFollowers(bot.followers);
                
                const content = [
                    "Just solved a major bug that was eating my weekend. Time for celebratory coffee. ☕",
                    "What's the best framework for a mobile simulator? Asking for a friend. 😉",
                    "Unpopular opinion: Pineapple on pizza is *fine*. Don't @ me.",
                    "If you're not failing, you're not trying hard enough. Keep building!",
                    "My favorite color is #F91880 (the like button).",
                    "Just finished an amazing book. Highly recommend it! (Book title not available).",
                    "I predict that the next big thing will be... something small. Details soon.",
                    "Lost my AirPods for the third time this week. Time to invest in a leash.",
                    "Remember to take a break and stare at a wall. It's good for your focus.",
                ][Math.floor(Math.random() * 9)];

                posts.push({
                    id: Date.now() + bot.id + i, // Ensure unique IDs
                    user: bot,
                    content: content,
                    timestamp: Date.now() - (3600 * 1000 * ageHours),
                    baseLikes: Math.floor(base * 0.005),
                    baseReposts: Math.floor(base * 0.001),
                    baseComments: Math.floor(base * 0.0005),
                    baseViews: Math.floor(base * 0.015)
                });
            }
        });
        return posts;
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY_PROFILE, JSON.stringify(userProfile));
        localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(userPosts));
        localStorage.setItem(STORAGE_KEY_BOT_POSTS, JSON.stringify(botPosts));
        localStorage.setItem(STORAGE_KEY_LAST_SESSION, Date.now()); 
    }
    
    function startStatUpdates() {
        if (statUpdateInterval) clearInterval(statUpdateInterval);
        
        statUpdateInterval = setInterval(() => {
            const now = Date.now();

            // Simulate follower growth for the user
            const currentFollowers = parseFollowers(userProfile.followers);
            const newFollowers = currentFollowers + Math.floor(Math.random() * 5 * (currentFollowers / 100000));
            userProfile.followers = formatNumber(newFollowers);
            
            // Only update follower count on the profile if it's visible, triggering the animation
            if (profileView.style.display !== 'none' && currentProfileView === 'user') {
                updateAnimatedStat('profileFollowerCount', userProfile.followers);
            }


            const applyOnlineGrowth = (post) => {
                if (post.timestamp < now) { 
                    post.baseLikes += Math.floor(Math.random() * 5); 
                    post.baseReposts += Math.floor(Math.random() * 2); 
                    post.baseComments += Math.floor(Math.random() * 1); 
                    post.baseViews += Math.floor(Math.random() * 25); 
                }
            };

            userPosts.forEach(applyOnlineGrowth);
            botPosts.forEach(applyOnlineGrowth);

            saveData(); 
            
            if (mainView.style.display !== 'none') {
                 renderFeed();
            } else if (profileView.style.display !== 'none') {
                 // Profile posts also need to update for consistency
                 renderProfilePosts(true); // Pass true to only update the feed, not the whole profile
            } else if (postDetailView.style.display !== 'none') { 
                const postId = document.getElementById('postDetailContent').getAttribute('data-post-id');
                const post = findPostById(postId);
                if (post) {
                    const stats = updatePostStats(post);
                    // Update stats directly using updateAnimatedStat
                    updateAnimatedStat('detail-stats-views', stats.views);
                    updateAnimatedStat('detail-stats-likes', stats.likes);
                    updateAnimatedStat('detail-stats-reposts', stats.reposts);
                    updateAnimatedStat('detail-stats-comments', stats.comments);
                }
            }
        }, UPDATE_INTERVAL_MS);
    }
    
    function updatePostStats(post) {
        return {
            comments: formatNumber(post.baseComments),
            reposts: formatNumber(post.baseReposts),
            likes: formatNumber(post.baseLikes),
            views: formatNumber(post.baseViews)
        };
    }
    
    function findPostById(postId) {
        const id = parseInt(postId);
        let post = userPosts.find(p => p.id === id);
        let isUser = true;
        if (!post) {
            post = botPosts.find(p => p.id === id);
            isUser = false;
        }
        if (post) {
            return {...post, isUser: isUser};
        }
        return null;
    }

    // --- UI Rendering Functions ---
    
    function updateAnimatedStat(elementId, newValue) {
        const element = document.getElementById(elementId);
        const newValueString = String(newValue); 
        
        if (element && element.textContent !== newValueString) {
            element.textContent = newValueString;
            // Only pulse if it's a visible stat on the profile/detail view
            // We apply the class to the parent .stat-item for the pulse effect
            if (profileView.style.display !== 'none' || postDetailView.style.display !== 'none') {
                const parentStatItem = element.closest('.stat-item');
                parentStatItem && parentStatItem.classList.add('stat-animated'); 
                setTimeout(() => parentStatItem && parentStatItem.classList.remove('stat-animated'), 500);
            }
        }
    }

    // Helper for rendering Avatars (PFP support)
    function createAvatarHTML(initial, color, pfp, sizeClass = '') {
        const finalColor = color === 'var(--primary-blue)' ? userProfile.themeColor : color;
        const style = pfp 
            ? `background-image: url('${pfp}'); background-color: ${finalColor};`
            : `background-color: ${finalColor};`;
        const content = pfp ? '' : initial;
        return `<div class="avatar ${sizeClass}" style="${style}">${content}</div>`;
    }

    function updateProfileUI() {
        // Update userProfile based on latest saved data
        userProfile.initial = userProfile.name.charAt(0).toUpperCase() || 'Y';
        userProfile.handle = `@${userProfile.name.replace(/[^a-zA-Z0-9_]/g, '')}`;

        // Global Avatars
        headerAvatar.outerHTML = createAvatarHTML(userProfile.initial, 'var(--primary-blue)', userProfile.pfp, '', `id="headerAvatar" onclick="showProfile('user')"`);
        modalAvatar.outerHTML = createAvatarHTML(userProfile.initial, 'var(--primary-blue)', userProfile.pfp, '', `id="modalAvatar"`);
        
        saveData();
    }
    
    function createPostHTML(post, isUser = true, isDetailView = false) {
        const stats = updatePostStats(post);
        const verifiedBadge = '<i class="fas fa-certificate verified-badge"></i>';
        
        let initial, rawDisplayName, displayName, color, pfp, clickHandler;

        if (!isUser) {
            initial = post.user.initial;
            rawDisplayName = post.user.name;
            displayName = post.user.handle;
            color = post.user.color;
            pfp = post.user.pfp;
            clickHandler = `showProfile('bot', ${post.user.id})`;
        } else {
            initial = userProfile.initial;
            rawDisplayName = userProfile.name;
            displayName = userProfile.handle;
            color = 'var(--primary-blue)'; // Will resolve to theme color in createAvatarHTML
            pfp = userProfile.pfp;
            clickHandler = `showProfile('user')`;
        }

        const avatarHTML = createAvatarHTML(initial, color, pfp);
        const postContentHTML = `<div class="${isDetailView ? 'post-detail-content' : 'post-content'}">${post.content}</div>`;
        
        // Post Detail Stats (now with IDs for dynamic animation)
        const postStatsHTML = isDetailView ? `
            <div class="post-detail-stats">
                <div class="stat-item"><strong id="detail-stats-likes">${stats.likes}</strong> Likes</div>
                <div class="stat-item"><strong id="detail-stats-reposts">${stats.reposts}</strong> Reposts</div>
                <div class="stat-item"><strong id="detail-stats-comments">${stats.comments}</strong> Comments</div>
                <div class="stat-item"><strong id="detail-stats-views">${stats.views}</strong> Views</div>
            </div>
        ` : ``;

        const postActionsClass = isDetailView ? 'post-actions post-detail-actions' : 'post-actions';

        const postBody = `
            <div class="post-body">
                <div class="post-header-info">
                    ${avatarHTML}
                    <div style="margin-left: 10px;">
                        <div style="display: flex; align-items: center;">
                            <span class="post-author-name" onclick="${clickHandler}">${rawDisplayName}</span>
                            ${verifiedBadge}
                        </div>
                        <span class="post-author-handle" onclick="${clickHandler}">${displayName}</span>
                    </div>
                </div>
                
                ${postContentHTML}
                
                ${isDetailView ? `<div class="post-detail-timestamp">${new Date(post.timestamp).toLocaleTimeString()} · ${new Date(post.timestamp).toLocaleDateString()}</div>` : ''}

                ${postStatsHTML}
                
                <div class="${postActionsClass}">
                    <div class="action-item comment" onclick="alert('Comment box simulation.')"><i class="far fa-comment"></i> ${isDetailView ? '' : `<span class="stat-value">${stats.comments}</span>`}</div>
                    <div class="action-item repost" onclick="alert('Repost simulation.')"><i class="fas fa-retweet"></i> ${isDetailView ? '' : `<span class="stat-value">${stats.reposts}</span>`}</div>
                    <div class="action-item like" onclick="alert('Like simulation.')"><i class="far fa-heart"></i> ${isDetailView ? '' : `<span class="stat-value">${stats.likes}</span>`}</div>
                    
                    ${isDetailView ? '' : `<div class="action-item view-count"><i class="fas fa-eye"></i> <span class="stat-value">${stats.views}</span></div>`}
                    
                    <div class="action-item share" onclick="alert('Share simulation.')" style="${isDetailView ? '' : 'margin-left: auto;'}"><i class="fas fa-arrow-up-from-bracket"></i></div>
                </div>
            </div>
        `;
        
        // Return full post structure, with onclick for non-detail view
        if (isDetailView) {
            return postBody;
        } else {
            return `
                <div class="post" id="post-${post.id}" onclick="showPostDetails(${post.id}, ${isUser})">
                    ${avatarHTML} ${postBody.replace(`<div class="post-body">`, `<div class="post-body" style="padding-left: 0;">`).replace(/<div class="post-header-info">.*?<\/div>/s, '')} 
                </div>
            `;
        }
    }

    function renderFeed() {
        if (currentTab === 'home') {
            const combinedFeed = [
                ...userPosts.map(p => ({...p, isUser: true})), 
                ...botPosts.map(p => ({...p, isUser: false}))
            ];
            combinedFeed.sort((a, b) => b.timestamp - a.timestamp);

            let newHTML = '';
            combinedFeed.forEach(post => {
                const postId = `post-${post.id}`;
                const existingPost = document.getElementById(postId);
                
                if (existingPost) {
                    const stats = updatePostStats(post);
                    // Find all stat-value spans within the post
                    const actions = existingPost.querySelectorAll('.stat-value');
                    
                    if (actions.length >= 4) {
                        const newStats = [stats.comments, stats.reposts, stats.likes, stats.views];
                        actions.forEach((action, index) => {
                            const newStat = newStats[index];
                            if (action.textContent !== newStat) {
                                action.textContent = newStat;
                                // For standard feed, apply animation directly to the icon container
                                action.closest('.action-item').classList.add('stat-animated');
                                setTimeout(() => action.closest('.action-item').classList.remove('stat-animated'), 500);
                            }
                        });
                    }
                } else {
                    newHTML += createPostHTML(post, post.isUser);
                }
            });
            
            if (newHTML || feed.children.length === 0) {
                 feed.insertAdjacentHTML('afterbegin', newHTML);
            }
        } else if (currentTab === 'communities') {
            renderCommunities();
        } else {
             feed.innerHTML = `<div style="padding: 20px; text-align: center;"><h2 style="color: var(--x-text-color);">${currentTab.charAt(0).toUpperCase() + currentTab.slice(1)}</h2><p style="color: var(--x-dim-text);">This tab is currently a **simulation**.</p></div>`;
        }
    }
    
    // Post Detail Rendering
    function showPostDetails(postId) {
        const post = findPostById(postId);
        if (!post) return;
        
        // Save the previous tab so we can go "back"
        document.getElementById('postDetailView').setAttribute('data-previous-tab', currentTab);
        
        // Switch to the detail view
        switchView('postDetail');
        
        const detailContainer = document.getElementById('postDetailContent');
        detailContainer.setAttribute('data-post-id', postId); // Store ID for stat updates
        
        const postHTML = createPostHTML(post, post.isUser, true);
        
        detailContainer.innerHTML = `
            <div class="post-detail-post-container">
                ${postHTML}
            </div>
            <div class="comments-section">
                <i class="fas fa-exclamation-circle" style="margin-right: 5px;"></i> Comments unavailable, coming soon.
            </div>
        `;
    }

    function renderCommunities() {
        mainView.style.display = 'none';
        communitiesView.style.display = 'block';
        
        let html = '<h2 style="padding: 10px 15px;">Trending Communities</h2><div class="community-list">';
        communitiesData.forEach(comm => {
            html += `
                <div class="community-item" onclick="alert('Joining ${comm.name}! (Simulated)')">
                    <div class="community-icon" style="background-color: ${comm.color};">
                        <i class="${comm.icon}"></i>
                    </div>
                    <div class="community-details">
                        <strong style="display: flex; align-items: center;">${comm.name} <i class="fas fa-certificate verified-badge"></i></strong>
                        <div class="members">${comm.handle} · ${comm.members} Members</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        document.getElementById('communityList').innerHTML = html;
    }

    function renderProfilePosts(onlyUpdateFeed = false) {
        let postsToRender = [];
        let profileDetails = {};
        
        if (currentProfileView === 'user') {
            postsToRender = userPosts;
            profileDetails = {
                name: userProfile.name,
                handle: userProfile.handle,
                avatarInitial: userProfile.initial,
                avatarColor: 'var(--primary-blue)',
                bio: userProfile.bio,
                location: userProfile.location,
                joined: userProfile.joined,
                posts: userPosts.length,
                followers: userProfile.followers, 
                following: userProfile.following,
                isBot: false,
                banner: userProfile.banner
            };
        } else {
            const bot = botData.find(b => b.id === currentProfileView.id);
            postsToRender = botPosts.filter(p => p.user.id === bot.id);
            profileDetails = {
                name: bot.name,
                handle: bot.handle,
                avatarInitial: bot.initial,
                avatarColor: bot.color,
                bio: bot.bio,
                location: bot.location,
                joined: bot.joined,
                posts: postsToRender.length,
                followers: bot.followers,
                following: bot.following,
                isBot: true,
                banner: bot.color 
            };
        }

        // Only update the profile header if it's the initial render
        if (!onlyUpdateFeed) {
            document.getElementById('profileDisplayName').textContent = profileDetails.name;
            document.getElementById('profileHandle').textContent = profileDetails.handle;
            document.getElementById('profileBio').textContent = profileDetails.bio;
            document.getElementById('profileLocation').textContent = profileDetails.location;
            document.getElementById('profileJoined').textContent = profileDetails.joined;
            
            const pfpElement = document.getElementById('profilePageAvatar');
            const finalColor = profileDetails.avatarColor === 'var(--primary-blue)' ? userProfile.themeColor : profileDetails.avatarColor;
            pfpElement.style.backgroundColor = finalColor;
            pfpElement.style.backgroundImage = profileDetails.pfp ? `url('${profileDetails.pfp}')` : '';
            pfpElement.textContent = profileDetails.pfp ? '' : profileDetails.avatarInitial;
            
            document.getElementById('profileBanner').style.background = profileDetails.banner.startsWith('#') || profileDetails.banner.includes('url') 
                ? profileDetails.banner 
                : `linear-gradient(135deg, ${profileDetails.banner}, #333)`;

            const followBtn = document.getElementById('followButton');
            const editBtn = document.getElementById('editProfileButton');

            if (profileDetails.isBot) {
                editBtn.style.display = 'none';
                followBtn.style.display = 'block';
                followBtn.textContent = 'Follow';
                followBtn.onclick = () => alert(`You followed ${profileDetails.handle}! (Simulation only)`);
            } else {
                followBtn.style.display = 'none';
                editBtn.style.display = 'block';
            }
        }

        // Update animated stats (always run, even if onlyUpdateFeed is true)
        updateAnimatedStat('profilePostCount', profileDetails.posts); // Posts count changes when a new post is made
        updateAnimatedStat('profileFollowerCount', profileDetails.followers);
        updateAnimatedStat('profileFollowingCount', profileDetails.following);
        
        // Update the posts feed itself
        postsToRender.sort((a, b) => b.timestamp - a.timestamp);
        profilePostsFeed.innerHTML = postsToRender.map(p => createPostHTML(p, !profileDetails.isBot)).join('');
    }

    // --- Profile Editing Logic ---

    function openEditProfileModal() {
        document.getElementById('editDisplayName').value = userProfile.name;
        document.getElementById('editFollowers').value = userProfile.followers;
        document.getElementById('editBio').value = userProfile.bio;
        document.getElementById('editLocation').value = userProfile.location;
        document.getElementById('editJoined').value = userProfile.joined;

        // Preview PFP
        const editAvatar = document.getElementById('editProfileAvatar');
        editAvatar.style.backgroundColor = userProfile.themeColor; // Use theme color
        editAvatar.style.backgroundImage = userProfile.pfp ? `url('${userProfile.pfp}')` : '';
        editAvatar.textContent = userProfile.pfp ? '' : userProfile.initial;
        
        // Preview Banner
        document.getElementById('editBanner').style.background = userProfile.banner.startsWith('#') || userProfile.banner.includes('url') 
            ? userProfile.banner 
            : `linear-gradient(135deg, ${userProfile.themeColor}, #333)`;

        editProfileModal.style.display = 'flex';
    }

    function closeEditProfileModal() {
        editProfileModal.style.display = 'none';
        pfpInput.value = ''; // Clear file input
    }
    
    // Handle File Input and Base64 Conversion
    pfpInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                userProfile.pfp = e.target.result;
                document.getElementById('editProfileAvatar').style.backgroundImage = `url('${e.target.result}')`;
                document.getElementById('editProfileAvatar').textContent = '';
                updateProfileUI(); 
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    function saveProfileChanges() {
        userProfile.name = document.getElementById('editDisplayName').value.trim() || "YourName";
        userProfile.followers = document.getElementById('editFollowers').value.trim() || "0";
        userProfile.bio = document.getElementById('editBio').value.trim();
        userProfile.location = document.getElementById('editLocation').value.trim();
        userProfile.joined = document.getElementById('editJoined').value.trim();
        
        userProfile.initial = userProfile.name.charAt(0).toUpperCase() || 'Y';
        userProfile.handle = `@${userProfile.name.replace(/[^a-zA-Z0-9_]/g, '')}`;

        saveData();
        updateProfileUI(); 
        renderProfilePosts(); 
        closeEditProfileModal();
    }

    // --- Settings Modal Logic ---

    function openSettingsModal(navItem) {
        // Switch active nav item
        document.getElementById('bottomNav').querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        navItem && navItem.classList.add('active');
        
        // Hide all main content views
        switchView(null);
        
        // Set active theme button
        document.getElementById('themeOptions').querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-color') === userProfile.themeColor) {
                btn.classList.add('active');
            }
        });

        settingsModal.style.display = 'flex';
    }

    function closeSettingsModal() {
        settingsModal.style.display = 'none';
        
        // Re-activate the last tab that was visible (home by default)
        switchTab(currentTab);
    }

    // --- View Switching Logic ---

    function switchView(view) {
        // Hide all main content views
        mainView.style.display = 'none';
        profileView.style.display = 'none';
        communitiesView.style.display = 'none';
        postDetailView.style.display = 'none'; 
        headerTabs.style.display = 'flex'; 
        settingsModal.style.display = 'none'; 

        if (view === 'main') {
            mainView.style.display = 'block';
        } else if (view === 'profile') {
            profileView.style.display = 'block';
            headerTabs.style.display = 'none';
        } else if (view === 'communities') {
            communitiesView.style.display = 'block';
            headerTabs.style.display = 'none'; 
        } else if (view === 'postDetail') { 
            postDetailView.style.display = 'block';
            headerTabs.style.display = 'none';
        }
    }
    
    function showProfile(type, botId = null) {
        if (type === 'user') {
            currentProfileView = 'user';
        } else if (type === 'bot') {
            const bot = botData.find(b => b.id === botId);
            if(bot) {
                currentProfileView = bot;
            } else {
                return;
            }
        }

        switchView('profile');
        renderProfilePosts();
    }

    function switchTab(tabName) {
        currentTab = tabName;
        
        // Update Bottom Nav
        document.getElementById('bottomNav').querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-tab') === tabName) {
                item.classList.add('active');
            }
        });
        
        // Update Header Tabs (only applies to Home/Search)
        document.getElementById('headerTabs').querySelectorAll('.tab-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-tab') === tabName) {
                item.classList.add('active');
            }
        });
        
        if (tabName === 'communities') {
            switchView('communities');
        } else if (tabName === 'settings') {
            openSettingsModal(document.querySelector('.nav-item[data-tab="settings"]'));
        } else {
            switchView('main');
            renderFeed();
        }
    }
    
    // --- Post/Modal Logic ---

    function checkPostLength() {
        modalPostButton.disabled = postTextarea.value.trim() === "";
    }

    function openPostModal() {
        postModal.style.display = 'flex';
        checkPostLength();
    }

    function closePostModal() {
        postModal.style.display = 'none';
        postTextarea.value = '';
    }

    function postTweet() {
        const content = postTextarea.value.trim();
        if (content === "") return;

        const newPost = {
            id: Date.now(),
            content: content,
            timestamp: Date.now(),
            baseLikes: 0,
            baseReposts: 0,
            baseComments: 0,
            baseViews: 0
        };

        userPosts.push(newPost);
        
        // Update post count immediately, triggering animation
        updateAnimatedStat('profilePostCount', userPosts.length);

        switchTab('home'); 
        closePostModal();
    }

    // --- Initialization ---

    loadData();

</script>

</body>
</html>