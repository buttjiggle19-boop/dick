<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PicPopper Mobile Simulator v7.4 (Trending Hashtags)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* CSS Variables for Modern X/Twitter Mobile Theme */
        :root {
            --primary-blue: #1d9bf0; 
            --primary-purple: #8000ff; /* New theme color */
            --x-dark: #000000;
            --x-light-gray: #16181c; 
            --x-text-color: #e7e9ea;
            --x-dim-text: #71767b; 
            --x-border: #2f3336;
        }

        /* --- Theme-Specific Styles --- */
        /* This dynamic block will be controlled by JavaScript */
        .theme-color-dynamic {
            color: var(--primary-color);
        }
        .theme-bg-dynamic {
            background-color: var(--primary-color);
        }
        .tab-item.active::after {
            background-color: var(--primary-color);
        }
        .header-logo {
            color: var(--primary-color); /* Updated for theme */
        }
        .avatar {
            color: var(--x-text-color); /* Avatar text is always light on dark theme */
            background-color: var(--primary-color); /* Updated for theme */
        }
        .verified-badge {
            color: var(--primary-color);
        }
        .fab-post {
            background-color: var(--primary-color); /* Updated for theme */
        }
        .nav-item.active {
            color: var(--primary-color); /* Updated for theme */
        }
        .modal-header button {
            background-color: var(--primary-color); /* Updated for theme */
        }
        .modal-header button:disabled {
            background-color: color-mix(in srgb, var(--primary-color) 70%, var(--x-dark));
            opacity: 0.7;
        }
        .edit-form-group label {
            color: var(--primary-color);
        }

        /* Base Body and Container Setup */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--x-dark);
            color: var(--x-text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 0;
            overflow-x: hidden;
            height: 100vh;
        }

        .simulator-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--x-dark);
            min-height: 100vh;
            position: relative;
            /* Space for sticky header (55px) and footer (55px) */
            padding-top: 55px; 
            padding-bottom: 55px; 
            box-sizing: border-box;
        }

        /* ---------------------------------- */
        /* 1. HEADER & NAVIGATION             */
        /* ---------------------------------- */
        .header-container {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 600px;
            background-color: var(--x-dark);
            z-index: 1000;
            border-bottom: 1px solid var(--x-border);
        }
        
        .top-header {
            height: 55px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        
        .header-logo {
            font-size: 20px;
            font-weight: 900;
            cursor: pointer; 
        }
        
        .header-logo i {
            margin-right: 5px;
        }
        
        .header .icon {
             font-size: 20px;
             color: var(--x-text-color);
        }

        /* Avatar Styling (Updated for PFP image support) */
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
            flex-shrink: 0; 
            /* Added for PFP image */
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }
        .avatar:active { transform: scale(0.9); }
        
        .header-tabs {
            display: flex;
            justify-content: space-around;
            height: 50px;
            border-bottom: 1px solid var(--x-border);
        }

        .tab-item {
            padding: 0 10px;
            color: var(--x-dim-text);
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .tab-item.active {
            color: var(--x-text-color);
        }
        
        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 4px;
            border-radius: 2px;
            animation: tabUnderline 0.3s ease-out;
        }
        
        /* ---------------------------------- */
        /* 2. POST DISPLAY & ANIMATION        */
        /* ---------------------------------- */
        .feed {
            min-height: 500px; 
        }

        /* POST LAYOUT FIX */
        .post {
            padding: 15px 15px 0 15px; /* Adjust padding for better look */
            border-bottom: 1px solid var(--x-border);
            display: flex;
            animation: fadeIn 0.3s ease-in-out;
            cursor: pointer; 
        }

        /* Post content column, next to the avatar */
        .post-content-container {
            flex-grow: 1;
            padding-left: 10px;
            padding-bottom: 15px; /* Move bottom padding here */
        }

        /* Fix post header alignment to match the new structure */
        .post-header-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px; /* Added spacing */
        }
        
        /* Stat Update Animation */
        .stat-animated {
            animation: statPulse 0.5s ease-out;
        }
        
        @keyframes statPulse {
            0% { color: var(--primary-color); transform: scale(1); }
            50% { color: var(--primary-color); transform: scale(1.1); }
            100% { color: var(--x-dim-text); transform: scale(1); }
        }

        /* Hashtag Styling */
        .post-content a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .post-content a:hover {
            text-decoration: underline;
        }


        /* --- POST ACTIONS FIX --- */
        .post-actions {
            display: flex;
            /* Changed from space-between to flex-start to allow the share button to be pushed to the right */
            justify-content: flex-start;
            gap: 20px; /* Spacing between the first four actions */
            margin-top: 15px;
            color: var(--x-dim-text);
            font-size: 13px;
            max-width: 450px;
        }

        .action-item {
            display: flex;
            align-items: center;
            gap: 5px; /* Spacing between icon and count */
            cursor: pointer;
            padding: 5px 0;
            transition: color 0.1s, transform 0.1s;
        }
        
        .post-actions .share {
            margin-left: auto; /* Pushes the share icon to the far right */
            gap: 0; /* Share button doesn't have a count */
        }

        /* ---------------------------------- */
        /* 2b. POST DETAIL VIEW               */
        /* ---------------------------------- */
        #postDetailView {
            display: none;
            position: relative;
        }
        .post-detail-header {
            position: sticky;
            top: 55px;
            z-index: 999;
            background-color: var(--x-dark);
            border-bottom: 1px solid var(--x-border);
            padding: 10px 15px;
        }
        .post-detail-header i {
            font-size: 20px;
            cursor: pointer;
        }
        .post-detail-post-container {
            padding: 15px;
            border-bottom: 1px solid var(--x-border);
        }
        .post-detail-post-container .post-body {
            padding-left: 0; 
        }
        .post-detail-post-container .post-header-info {
            margin-bottom: 10px;
        }
        .post-detail-post-container .avatar {
            width: 48px;
            height: 48px;
            font-size: 20px;
        }
        .post-detail-content {
            font-size: 18px;
            line-height: 1.4;
            margin-bottom: 15px;
        }
        .post-detail-timestamp {
            color: var(--x-dim-text);
            font-size: 14px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--x-border);
        }
        .post-detail-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--x-border);
        }
        .post-detail-stats strong {
            color: var(--x-text-color);
            margin-right: 5px;
        }
        /* Detail actions need to be spread out again since they don't have counts */
        .post-detail-actions {
            justify-content: space-around !important;
            max-width: 100% !important;
        }
        .comments-section {
            padding: 15px;
            text-align: center;
            color: var(--x-dim-text);
        }

        /* ---------------------------------- */
        /* 2c. TRENDING VIEW                  */
        /* ---------------------------------- */
        #trendingView {
            display: none;
            padding: 5px 0;
        }
        .trending-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--x-border);
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .trending-item:hover {
            background-color: var(--x-light-gray);
        }
        .trending-category {
            font-size: 12px;
            color: var(--x-dim-text);
        }
        .trending-hashtag {
            font-size: 16px;
            font-weight: bold;
            color: var(--x-text-color);
            margin: 2px 0;
        }
        .trending-views {
            font-size: 14px;
            color: var(--x-dim-text);
        }
        
        /* ---------------------------------- */
        /* 3. PROFILE PAGE VIEW               */
        /* ---------------------------------- */
        #profileView {
            display: none;
            padding: 0;
        }
        
        .profile-content-scroll {
             height: 100%;
             overflow-y: auto;
             -webkit-overflow-scrolling: touch;
        }

        .profile-header-container {
            position: relative;
            background-color: var(--x-dark);
            padding-top: 55px; /* Space for the fixed header */
        }

        .banner {
            width: 100%;
            height: 150px;
            /* Banner will get its background from JS/userProfile.banner */
            background: linear-gradient(135deg, var(--primary-color), #333); 
        }

        .profile-details {
            padding: 0 15px 15px 15px;
            margin-top: -60px;
        }

        .profile-page-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--x-dark);
            font-size: 30px;
            margin-bottom: 10px;
        }

        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 15px;
        }

        .stat-item {
            color: var(--x-dim-text);
        }
        .stat-item strong {
            color: var(--x-text-color);
            margin-right: 5px;
            transition: color 0.5s, transform 0.5s; /* Ensure strong is part of animation */
        }
        
        .follow-button, #editProfileButton {
            float: right;
            background-color: var(--x-text-color);
            color: var(--x-dark);
            border: none;
            padding: 8px 18px;
            border-radius: 9999px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -30px;
            transition: background-color 0.2s;
        }
        #editProfileButton {
            background-color: var(--x-dark);
            color: var(--x-text-color);
            border: 1px solid var(--x-border);
        }
        
        /* ---------------------------------- */
        /* 4. MODAL STYLING (Post & Edit & Premium)     */
        /* ---------------------------------- */
        #postModal, #editProfileModal, #settingsModal, #premiumModal, #hashtagModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--x-dark); 
            z-index: 2000;
            justify-content: center;
            align-items: flex-start;
        }

        .modal-content {
            width: 100%;
            max-width: 600px;
            background-color: var(--x-dark);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--x-border);
            padding: 10px 15px;
            flex-shrink: 0;
        }
        
        .modal-header .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--x-text-color);
            padding: 5px;
        }
        
        /* Settings List Styles */
        .settings-list {
            padding: 15px;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--x-border);
            cursor: pointer;
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .theme-options button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--x-border);
            margin-left: 5px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .theme-options button.active {
            border-color: var(--x-text-color);
            border-width: 4px;
        }
        
        /* ---------------------------------- */
        /* 5. COMMUNITIES VIEW                */
        /* ---------------------------------- */
        #communitiesView {
            display: none;
        }
        .community-list {
            padding: 15px;
        }
        .community-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--x-border);
            cursor: pointer;
        }
        .community-item:last-child {
            border-bottom: none;
        }
        .community-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }
        .community-details {
            margin-left: 15px;
        }
        .community-details .members {
            color: var(--x-dim-text);
            font-size: 14px;
        }
        
        /* ---------------------------------- */
        /* 6. OTHER STYLES (Bottom Nav, FAB)  */
        /* ---------------------------------- */

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px;
            height: 55px;
            background-color: var(--x-dark);
            border-top: 1px solid var(--x-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        .nav-item {
            color: var(--x-dim-text);
            font-size: 22px;
            padding: 10px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .fab-post {
            position: fixed;
            bottom: 70px;
            right: 15px;
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            z-index: 1001;
            right: calc(50% - 300px + 15px);
        }
        
        @media (max-width: 600px) {
            .fab-post {
                right: 15px;
            }
        }
    </style>
</head>
<body>

<div class="simulator-container">

    <div class="header-container" id="headerContainer">
        <div class="top-header">
            <div class="avatar" id="headerAvatar" onclick="showProfile('user')">Y</div>
            <div class="header-logo" onclick="switchTab('home')"><i class="fas fa-camera"></i>PicPopper</div>
            <i class="far fa-bell icon" onclick="switchTab('notifications')"></i>
        </div>
        <div class="header-tabs main-view-tabs" id="headerTabs">
            <div class="tab-item active" data-tab="home" onclick="switchTab('home')">For You</div>
            <div class="tab-item" data-tab="trending" onclick="switchTab('trending')">Trending</div>
        </div>
    </div>
    
    <div id="mainView" style="display: block;">
        <div class="feed" id="feed"></div>
    </div>
    
    <div id="trendingView" style="display: none;">
        <h2 style="padding: 10px 15px;">What's trending</h2>
        <div id="trendingList"></div>
    </div>

    <div id="communitiesView" style="display: none; padding-top: 5px;">
        <div class="community-list" id="communityList">
            </div>
    </div>

    <div id="postDetailView" style="display: none;">
        <div class="post-detail-header">
            <i class="fas fa-arrow-left icon" onclick="switchTab(document.getElementById('postDetailView').getAttribute('data-previous-tab') || 'home')"></i>
        </div>
        <div id="postDetailContent">
            </div>
    </div>

    <div id="profileView" style="display: none;">
        <div class="profile-header-container">
            <div class="top-header" style="position: absolute; width: 100%; max-width: 600px; padding: 0 10px; background: none; border-bottom: none;">
                <i class="fas fa-arrow-left icon" onclick="switchTab('home')" style="cursor:pointer; background: rgba(0,0,0,0.5); padding: 5px 8px; border-radius: 50%; color: white;"></i>
                <i class="fas fa-ellipsis-v icon" style="background: rgba(0,0,0,0.5); padding: 5px 8px; border-radius: 50%; color: white;"></i>
            </div>
            
            <div class="profile-content-scroll" style="height: calc(100vh - 55px);">

                <div class="banner" id="profileBanner"></div>
                <div class="profile-details">
                    <button class="follow-button" id="editProfileButton" onclick="openEditProfileModal()">Edit Profile</button>
                    <button class="follow-button" id="followButton" style="display: none;">Follow</button>
                    
                    <div class="avatar profile-page-avatar" id="profilePageAvatar">Y</div>
                    
                    <h2 style="margin: 0; display: flex; align-items: center;" id="profileDisplayNameContainer">
                        <span id="profileDisplayName"></span>
                        <i class="fas fa-certificate verified-badge"></i>
                    </h2>
                    <span style="color: var(--x-dim-text);" id="profileHandle"></span>
                    
                    <p class="profile-bio" id="profileBio"></p>
                    
                    <div class="profile-location"><i class="fas fa-location-dot"></i><span id="profileLocation"></span></div>
                    <div class="profile-joined"><i class="fas fa-calendar-alt"></i>Joined <span id="profileJoined"></span></div>

                    <div class="profile-stats">
                        <div class="stat-item"><strong id="profilePostCount">0</strong> Posts</div>
                        <div class="stat-item"><strong id="profileFollowingCount">0</strong> Following</div>
                        <div class="stat-item"><strong id="profileFollowerCount">0</strong> Followers</div>
                    </div>
                </div>
                
                <div class="header-tabs">
                    <div class="tab-item active">Posts</div>
                    <div class="tab-item">Likes (Simulated)</div>
                </div>
                
                <div id="profilePostsFeed" class="feed"></div>
            </div>
        </div>
    </div>

    <div class="fab-post theme-bg-dynamic" onclick="openPostModal()">
        <i class="fas fa-plus"></i>
    </div>

    <div class="bottom-nav" id="bottomNav">
        <div class="nav-item active" data-tab="home" onclick="switchTab('home', this)"><i class="fas fa-house"></i></div>
        <div class="nav-item" data-tab="trending" onclick="switchTab('trending', this)"><i class="fas fa-magnifying-glass"></i></div>
        <div class="nav-item" data-tab="communities" onclick="switchTab('communities', this)"><i class="fas fa-users"></i></div>
        <div class="nav-item" data-tab="notifications" onclick="switchTab('notifications', this)"><i class="far fa-bell"></i></div>
        <div class="nav-item" data-tab="settings" onclick="openSettingsModal(this)"><i class="fas fa-gear"></i></div> </div>
    
</div>

<div id="postModal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closePostModal()"><i class="fas fa-times"></i></span>
            <button id="modalPostButton" onclick="postTweet()" disabled>Post</button>
        </div>
        <div class="modal-post-area" style="display: flex; padding: 15px;">
            <div class="avatar" id="modalAvatar">Y</div>
            <textarea id="postText" class="modal-textarea" placeholder="What's popping?" oninput="checkPostLength()" style="flex-grow: 1; margin-left: 10px; background: transparent; border: none; color: var(--x-text-color); font-size: 20px; outline: none; resize: none;"></textarea>
        </div>
        <div class="modal-footer" style="padding: 10px 15px; border-top: 1px solid var(--x-border); margin-top: auto; display: flex; justify-content: space-between;">
            <div>
                <i class="far fa-image icon" style="margin-right: 15px;"></i>
                <i class="fas fa-bars-staggered icon" style="margin-right: 15px;"></i>
                <i class="far fa-face-smile icon"></i>
            </div>
        </div>
    </div>
</div>

<div id="editProfileModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closeEditProfileModal()"><i class="fas fa-times"></i></span>
            <h3 style="margin:0; font-weight: bold;">Edit Profile</h3>
            <button onclick="saveProfileChanges()">Save</button>
        </div>
        <div style="padding: 15px; overflow-y: auto;">
            <div class="banner" id="editBanner" style="height: 100px; margin-bottom: -50px; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('pfpInput').click()">
                </div>
            
            <div class="avatar profile-page-avatar" id="editProfileAvatar" style="cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('pfpInput').click()">Y</div>
            <input type="file" id="pfpInput" accept="image/*" style="display: none;">
            
            <p style="color: var(--x-dim-text); font-size: 14px; margin-top: 10px;">Click the avatar or banner to change your profile picture.</p>

            <div class="edit-form-group">
                <label for="editDisplayName">Name</label>
                <input type="text" id="editDisplayName" maxlength="15">
            </div>
            <div class="edit-form-group">
                <label for="editFollowers">Followers (for growth demo)</label>
                <input type="text" id="editFollowers" maxlength="10">
            </div>
            <div class="edit-form-group">
                <label for="editBio">Bio</label>
                <textarea id="editBio" maxlength="160"></textarea>
            </div>
            <div class="edit-form-group">
                <label for="editLocation">Location</label>
                <input type="text" id="editLocation" maxlength="30">
            </div>
            <div class="edit-form-group">
                <label for="editJoined">Joined Date (e.g., Nov 2023)</label>
                <input type="text" id="editJoined" maxlength="30">
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closeSettingsModal()"><i class="fas fa-arrow-left"></i></span>
            <h3 style="margin:0; font-weight: bold;">Settings</h3>
            <div></div> </div>
        <div class="settings-list">
            <div class="setting-item" onclick="openPremiumModal()">
                <span style="font-weight: bold; color: gold;"><i class="fas fa-star" style="margin-right: 5px;"></i> PicPopper Premium</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="setting-item">
                <span style="font-weight: bold;">Theme Color</span>
                <div class="theme-options" id="themeOptions">
                    <button style="background-color: #1d9bf0;" data-color="#1d9bf0" onclick="applyTheme('#1d9bf0')"></button>
                    <button style="background-color: #8000ff;" data-color="#8000ff" onclick="applyTheme('#8000ff')"></button>
                    <button style="background-color: #00ff00;" data-color="#00ff00" onclick="applyTheme('#00ff00')"></button>
                    <button style="background: linear-gradient(45deg, #FF6B6B, #FFD93D);" data-color="linear-gradient(45deg, #FF6B6B, #FFD93D)" onclick="applyTheme('linear-gradient(45deg, #FF6B6B, #FFD93D)')" disabled title="Premium Only"></button>
                    <button style="background: linear-gradient(135deg, #4A90E2, #50E3C2);" data-color="linear-gradient(135deg, #4A90E2, #50E3C2)" onclick="applyTheme('linear-gradient(135deg, #4A90E2, #50E3C2)')" disabled title="Premium Only"></button>
                    <button style="background: linear-gradient(90deg, #E91E63, #9C27B0);" data-color="linear-gradient(90deg, #E91E63, #9C27B0)" onclick="applyTheme('linear-gradient(90deg, #E91E63, #9C27B0)')" disabled title="Premium Only"></button>
                </div>
            </div>
            <div class="setting-item" onclick="alert('Display settings coming soon!')">
                <span style="font-weight: bold;">Display and language</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="setting-item" onclick="alert('Privacy settings coming soon!')">
                <span style="font-weight: bold;">Privacy and safety</span>
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>
</div>

<div id="premiumModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closePremiumModal()"><i class="fas fa-arrow-left"></i></span>
            <h3 style="margin:0; font-weight: bold; color: gold;">PicPopper Premium</h3>
            <div></div> </div>
        <div class="settings-list" style="padding: 15px; text-align: center;">
            <p style="font-size: 18px; margin-bottom: 20px;">Unlock exclusive features for only <strong style="color: gold;">$10 / month (Simulated)</strong>.</p>
            
            <div style="text-align: left; margin-bottom: 25px;">
                <h4 style="margin-top: 0; color: gold;"><i class="fas fa-crown"></i> Premium Features:</h4>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 10px;"><i class="fas fa-check-circle theme-color-dynamic" style="margin-right: 8px;"></i> **3 Gradient Themes** or upload your own background.</li>
                    <li style="margin-bottom: 10px;"><i class="fas fa-check-circle theme-color-dynamic" style="margin-right: 8px;"></i> Choose your **Custom Badge** to display on posts.</li>
                    <li style="margin-bottom: 10px;"><i class="fas fa-check-circle theme-color-dynamic" style="margin-right: 8px;"></i> **Boost your View Count** growth multiplier! (Currently ${userProfile.isPremium ? '3x' : '1x'})</li>
                </ul>
            </div>

            <button class="follow-button theme-bg-dynamic" style="width: 100%; margin-bottom: 15px;" onclick="promptPremiumCode()">${userProfile.isPremium ? 'Premium is ACTIVE!' : 'Activate Premium Now'}</button>
            <p style="color: var(--x-dim-text); font-size: 14px;">Enter the hidden code to simulate activation.</p>
        </div>
    </div>
</div>

<div id="hashtagModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-btn" onclick="closeHashtagModal()"><i class="fas fa-arrow-left"></i></span>
            <h3 style="margin:0; font-weight: bold;" id="hashtagModalTitle"></h3>
            <div></div> 
        </div>
        <div id="hashtagPostsFeed" class="feed" style="overflow-y: auto;">
        </div>
    </div>
</div>

<script>
    // --- Global Variables and Constants ---
    const STORAGE_KEY_POSTS = 'picpopper_user_posts_v7_4';
    const STORAGE_KEY_PROFILE = 'picpopper_user_profile_v7_4'; 
    const STORAGE_KEY_BOT_POSTS = 'picpopper_bot_posts_v7_4';
    const STORAGE_KEY_LAST_SESSION = 'picpopper_last_session_v7_4';
    const STORAGE_KEY_THEME = 'picpopper_theme_color_v7_4'; 
    
    const postTextarea = document.getElementById('postText');
    const feed = document.getElementById('feed');
    const profilePostsFeed = document.getElementById('profilePostsFeed');
    const postModal = document.getElementById('postModal');
    const modalPostButton = document.getElementById('modalPostButton');
    const headerAvatar = document.getElementById('headerAvatar');
    const modalAvatar = document.getElementById('modalAvatar');
    const profilePageAvatar = document.getElementById('profilePageAvatar');
    const mainView = document.getElementById('mainView');
    const profileView = document.getElementById('profileView');
    const communitiesView = document.getElementById('communitiesView');
    const trendingView = document.getElementById('trendingView');
    const postDetailView = document.getElementById('postDetailView'); 
    const headerTabs = document.getElementById('headerTabs');
    const editProfileModal = document.getElementById('editProfileModal');
    const settingsModal = document.getElementById('settingsModal'); 
    const hashtagModal = document.getElementById('hashtagModal'); 
    const pfpInput = document.getElementById('pfpInput');

    let userPosts = [];
    let botPosts = [];
    let currentTab = 'home';
    let currentProfileView = null; 
    let statUpdateInterval; 
    const UPDATE_INTERVAL_MS = 3000; 

    // Unified User Profile State
    let userProfile = {
        name: "YourName",
        handle: "@YourName",
        initial: "Y",
        followers: "455K",
        following: "22K",
        bio: 'This is your self-proclaimed bio. Edit your profile!',
        location: 'Simulator',
        joined: 'Today',
        pfp: null, 
        banner: '#1d9bf0', 
        themeColor: '#1d9bf0',
        // --- PREMIUM STATE ---
        isPremium: false, 
        premiumBadge: 'fas fa-star', 
        viewGrowthMultiplier: 1, 
        customTheme: null 
    };

    // --- Bot and Communities Data Definition ---
    const botData = [
        { id: 1000, name: 'CryptoWhale', handle: '@WhaleTrade', initial: 'C', color: '#ffd700', bio: 'I trade crypto and tweet nonsense. Not financial advice. Always FOMO.', location: 'Mars', joined: 'Oct 2021', followers: '850K', following: '120', pfp: null },
        { id: 1001, name: 'AI_Geek', handle: '@FutureMind', initial: 'A', color: '#00ccff', bio: 'Exploring the intersection of LLMs and human consciousness. Code is art.', location: 'San Francisco, CA', joined: 'Apr 2020', followers: '1.2M', following: '500', pfp: null },
        { id: 1002, name: 'FoodieBabe', handle: '@EatsLife', initial: 'F', color: '#ff69b4', bio: 'If it tastes good, I post it. Professional eater and amateur baker. 🍕', location: 'New York, NY', joined: 'Jan 2018', followers: '350K', following: '980', pfp: null },
        { id: 1003, name: 'TechNewsNow', handle: '@TechBuzz', initial: 'T', color: '#00ff00', bio: 'Breaking news in gadgets and innovation. If it plugs in, we cover it.', location: 'Global', joined: 'Nov 2022', followers: '2.1M', following: '15', pfp: null },
        { id: 1004, name: 'Minimalist_Z', handle: '@ZenLife', initial: 'Z', color: '#7b1fa2', bio: 'Less is more. Digital declutter advocate. Find peace in the void.', location: 'Kyoto, Japan', joined: 'Jun 2019', followers: '150K', following: '20', pfp: null },
    ];
    
    const communitiesData = [
        { name: 'Crypto Trading Hub', handle: '#CryptoTrade', members: '8.1M', color: '#ffd700', icon: 'fas fa-dollar-sign' },
        { name: 'AI/ML Enthusiasts', handle: '#MachineLearning', members: '6.5M', color: '#00ccff', icon: 'fas fa-microchip' },
        { name: 'Global Food Critics', handle: '#EatsLife', members: '4.9M', color: '#ff69b4', icon: 'fas fa-utensils' },
        { name: 'Tech News Digest', handle: '#TechBuzz', members: '7.2M', color: '#00ff00', icon: 'fas fa-newspaper' },
        { name: 'Retro Gaming', handle: '#PixelPerfect', members: '5.4M', color: '#8888ff', icon: 'fas fa-gamepad' },
    ];
    
    // --- Ad Post Data (Reduced to one, less aggressive) ---
    const adPosts = [
        {
            id: 9000,
            type: 'ad_premium',
            content: "Tired of slow growth? Unlock **3x faster** view counts and exclusive themes! Tap to activate Premium now.",
            timestamp: Date.now() - (3600 * 1000 * 5), 
            baseLikes: 500,
            baseReposts: 50,
            baseComments: 20,
            baseViews: 15000,
            adDetails: {
                name: 'PicPopper Premium',
                handle: '@PicPopper',
                initial: 'P',
                color: 'gold',
                actionButton: true,
                actionFunction: 'promptPremiumCode()'
            }
        },
    ];
    
    const genericHashtags = [
        'SimulatorLife', 'CodingIsFun', 'WebDev', 'TechTalk', 'FoodPorn', 'TravelGoals', 'DeepLearning', 'Gaming', 'Fitness', 'Art', 'Motivation', 'MondayMood'
    ];


    // --- Utility Functions ---

    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
        return Math.floor(num).toString();
    }
    
    function parseFollowers(followers) {
        const f = followers.toUpperCase();
        if (f.includes('M')) return parseFloat(f.replace('M', '')) * 1000000;
        if (f.includes('K')) return parseFloat(f.replace('K', '')) * 1000;
        return parseInt(f) || 50;
    }

    function timeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "y";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "mo";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "d";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "h";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "m";
        return Math.floor(seconds) + "s";
    }

    function extractHashtags(text) {
        const regex = /#(\w+)/g;
        return (text.match(regex) || []).map(tag => tag.substring(1));
    }
    
    function linkHashtags(text) {
        const regex = /#(\w+)/g;
        return text.replace(regex, (match, tag) => {
            return `<a href="#" onclick="showHashtagPosts('${tag}'); return false;">#${tag}</a>`;
        });
    }

    // --- Persistence and Time-Warp Logic ---
    
    // Theme Logic
    function applyTheme(color) {
        document.documentElement.style.setProperty('--primary-color', color);
        userProfile.themeColor = color;
        localStorage.setItem(STORAGE_KEY_THEME, color);

        // Update active state in settings modal
        document.getElementById('themeOptions')?.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-color') === color) {
                btn.classList.add('active');
            }
        });
        
        // Re-render anything necessary (like banner in case it uses a gradient with the theme color)
        if (profileView.style.display !== 'none' && currentProfileView === 'user') {
            renderProfilePosts();
        }
    }

    function calculateOfflineGrowth(post, timeElapsedHours) {
        if (timeElapsedHours <= 0) return;

        const growthFactor = Math.log10(timeElapsedHours + 1) * 0.5 + 1; 

        post.baseLikes = Math.floor(post.baseLikes + (timeElapsedHours * 5 * growthFactor * Math.random()));
        post.baseReposts = Math.floor(post.baseReposts + (timeElapsedHours * 2 * growthFactor * Math.random()));
        post.baseComments = Math.floor(post.baseComments + (timeElapsedHours * 1 * growthFactor * Math.random()));
        post.baseViews = Math.floor(post.baseViews + (timeElapsedHours * 50 * growthFactor * Math.random() * userProfile.viewGrowthMultiplier)); // Added multiplier
    }

    function loadData() {
        // 0. Load Theme FIRST
        const storedTheme = localStorage.getItem(STORAGE_KEY_THEME);
        if (storedTheme) {
            userProfile.themeColor = storedTheme;
        }
        applyTheme(userProfile.themeColor); 
        
        const now = Date.now();
        const lastSessionTime = parseInt(localStorage.getItem(STORAGE_KEY_LAST_SESSION) || now);
        const timeElapsedHours = (now - lastSessionTime) / (3600 * 1000); 

        // 1. Load Profile
        const storedProfile = JSON.parse(localStorage.getItem(STORAGE_KEY_PROFILE));
        if (storedProfile) {
             userProfile = {
                ...userProfile, 
                ...storedProfile, 
                themeColor: userProfile.themeColor,
                isPremium: storedProfile.isPremium || false, // Ensure status loads
                premiumBadge: storedProfile.premiumBadge || 'fas fa-star',
                viewGrowthMultiplier: storedProfile.viewGrowthMultiplier || 1,
                customTheme: storedProfile.customTheme || null
            };
            // Simulate follower growth when user is offline
            const currentFollowers = parseFollowers(userProfile.followers);
            const newFollowers = currentFollowers + Math.floor(timeElapsedHours * 20 * Math.random() * (currentFollowers / 100000));
            userProfile.followers = formatNumber(newFollowers);
        }

        // 2. Load and Grow User Posts
        userPosts = JSON.parse(localStorage.getItem(STORAGE_KEY_POSTS)) || [];
        userPosts.forEach(post => calculateOfflineGrowth(post, timeElapsedHours));
        
        if (userPosts.length === 0) {
            userPosts = [{
                id: Date.now(),
                content: "Welcome to PicPopper! Your stats were updated based on the " + timeElapsedHours.toFixed(2) + " hours you were away. New posts start at 0! #PicPopperSim #Hello",
                timestamp: Date.now() - (3600 * 1000 * 48), 
                baseLikes: 50,
                baseReposts: 10,
                baseComments: 5,
                baseViews: 500
            }];
        }

        // 3. Load and Grow Bot Posts
        botPosts = JSON.parse(localStorage.getItem(STORAGE_KEY_BOT_POSTS));
        if (!botPosts || botPosts.length === 0) {
            botPosts = generateInitialBotPosts();
        }
        botPosts.forEach(post => calculateOfflineGrowth(post, timeElapsedHours));
        
        // 4. Grow Ad Posts (Ad posts are static, so we only need to apply growth)
        adPosts.forEach(post => calculateOfflineGrowth(post, timeElapsedHours));
        
        // 5. Update UI and start real-time updates
        updateProfileUI();
        startStatUpdates();
    }

    function generateInitialBotPosts() {
        let posts = [];
        botData.forEach(bot => {
            const numPosts = Math.floor(Math.random() * 3) + 1; 
            for (let i = 0; i < numPosts; i++) {
                const ageHours = Math.floor(Math.random() * 72) + 1; 
                const base = parseFollowers(bot.followers);
                
                const content = [
                    "Just solved a major bug that was eating my weekend. Time for celebratory coffee. ☕ #CodingIsFun",
                    "What's the best framework for a mobile simulator? Asking for a friend. 😉 #WebDev",
                    "Unpopular opinion: Pineapple on pizza is *fine*. Don't @ me. #FoodPorn",
                    "If you're not failing, you're not trying hard enough. Keep building! #Motivation",
                    "My favorite color is #F91880 (the like button). #TechTalk",
                    "Just finished an amazing book. Highly recommend it! (Book title not available). #Art",
                    "I predict that the next big thing will be... something small. Details soon. #DeepLearning",
                    "Lost my AirPods for the third time this week. Time to invest in a leash. #TechTalk",
                    "Remember to take a break and stare at a wall. It's good for your focus. #ZenLife",
                ][Math.floor(Math.random() * 9)];

                posts.push({
                    id: Date.now() + bot.id + i, // Ensure unique IDs
                    user: bot,
                    content: content,
                    timestamp: Date.now() - (3600 * 1000 * ageHours),
                    baseLikes: Math.floor(base * 0.005),
                    baseReposts: Math.floor(base * 0.001),
                    baseComments: Math.floor(base * 0.0005),
                    baseViews: Math.floor(base * 0.015)
                });
            }
        });
        return posts;
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY_PROFILE, JSON.stringify(userProfile));
        localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(userPosts));
        localStorage.setItem(STORAGE_KEY_BOT_POSTS, JSON.stringify(botPosts));
        localStorage.setItem(STORAGE_KEY_LAST_SESSION, Date.now()); 
    }
    
    function startStatUpdates() {
        if (statUpdateInterval) clearInterval(statUpdateInterval);
        
        statUpdateInterval = setInterval(() => {
            const now = Date.now();
            
            // Generate a random post by a bot occasionally
            if (Math.random() < 0.1) { // 10% chance every 3 seconds
                generateBotPost();
            }

            // Simulate follower growth for the user
            const currentFollowers = parseFollowers(userProfile.followers);
            const newFollowers = currentFollowers + Math.floor(Math.random() * 5 * (currentFollowers / 100000));
            userProfile.followers = formatNumber(newFollowers);
            
            // Only update follower count on the profile if it's visible, triggering the animation
            if (profileView.style.display !== 'none' && currentProfileView === 'user') {
                updateAnimatedStat('profileFollowerCount', userProfile.followers);
            }

            const applyOnlineGrowth = (post) => {
                if (post.timestamp < now) { 
                    post.baseLikes += Math.floor(Math.random() * 5); 
                    post.baseReposts += Math.floor(Math.random() * 2); 
                    post.baseComments += Math.floor(Math.random() * 1); 
                    post.baseViews += Math.floor(Math.random() * 25 * userProfile.viewGrowthMultiplier); // Applies multiplier
                }
            };

            userPosts.forEach(applyOnlineGrowth);
            botPosts.forEach(applyOnlineGrowth);
            adPosts.forEach(applyOnlineGrowth); // Apply growth to ad posts

            saveData(); 
            
            // RE-RENDER/UPDATE LOGIC FIX
            if (mainView.style.display !== 'none' && currentTab === 'home') {
                 // Use a dedicated function to only update stats on the feed without full re-render
                 updateFeedStats(feed);
            } else if (trendingView.style.display !== 'none') {
                renderTrending(); // Full render is fine here as it's a small list
            } else if (profileView.style.display !== 'none') {
                 // Profile posts also need to update for consistency
                 updateFeedStats(profilePostsFeed);
            } else if (postDetailView.style.display !== 'none') { 
                const postId = document.getElementById('postDetailContent').getAttribute('data-post-id');
                const post = findPostById(postId);
                if (post) {
                    const stats = updatePostStats(post);
                    // Update stats directly using updateAnimatedStat
                    updateAnimatedStat('detail-stats-views', stats.views);
                    updateAnimatedStat('detail-stats-likes', stats.likes);
                    updateAnimatedStat('detail-stats-reposts', stats.reposts);
                    updateAnimatedStat('detail-stats-comments', stats.comments);
                }
            } else if (hashtagModal.style.display !== 'none') {
                 // Update stats in the hashtag modal
                 updateFeedStats(document.getElementById('hashtagPostsFeed'));
            }
        }, UPDATE_INTERVAL_MS);
    }
    
    function generateBotPost() {
        const bot = botData[Math.floor(Math.random() * botData.length)];
        const base = parseFollowers(bot.followers);
        
        let content = [
            "Another day, another line of code. Feeling productive! #CodingIsFun",
            "This view is incredible! Wish I could stay here forever. #TravelGoals",
            "Just had the best [random food] of my life. You have to try it! #FoodPorn",
            "Thinking about the future of AI. What are your predictions? #DeepLearning",
            "Keep pushing your limits. You're stronger than you think. #Motivation"
        ][Math.floor(Math.random() * 5)];
        
        // --- BOT HASHTAG ADOPTION LOGIC ---
        const recentUserPosts = userPosts.slice(0, 5); // Look at last 5 user posts
        let adoptedHashtag = null;
        
        for (const post of recentUserPosts) {
            const tags = extractHashtags(post.content);
            if (tags.length > 0 && Math.random() < 0.5) { // 50% chance of adopting a tag
                adoptedHashtag = tags[Math.floor(Math.random() * tags.length)];
                break;
            }
        }
        
        if (adoptedHashtag) {
            content += ` Watching the trends, I see. What's the fuss about #${adoptedHashtag}?`;
        } else {
            // Add a random generic hashtag if none was adopted
            content += ` #${genericHashtags[Math.floor(Math.random() * genericHashtags.length)]}`;
        }
        
        const newPost = {
            id: Date.now(),
            user: bot,
            content: content,
            timestamp: Date.now(),
            baseLikes: Math.floor(base * 0.005 * 0.5), // Smaller initial stats for new post
            baseReposts: Math.floor(base * 0.001 * 0.5),
            baseComments: Math.floor(base * 0.0005 * 0.5),
            baseViews: Math.floor(base * 0.015 * 0.5)
        };
        
        botPosts.unshift(newPost);
        botPosts.sort((a, b) => b.timestamp - a.timestamp); // Re-sort for display order
    }

    function updatePostStats(post) {
        return {
            comments: formatNumber(post.baseComments),
            reposts: formatNumber(post.baseReposts),
            likes: formatNumber(post.baseLikes),
            views: formatNumber(post.baseViews)
        };
    }
    
    function findPostById(postId) {
        const id = parseInt(postId);
        let post = userPosts.find(p => p.id === id);
        let isUser = true;
        if (!post) {
            post = botPosts.find(p => p.id === id);
            isUser = false;
        }
        // Check ads too
        if (!post) {
            post = adPosts.find(p => p.id === id);
            isUser = false; // Ads are not user posts
        }
        
        if (post) {
            return {...post, isUser: isUser};
        }
        return null;
    }

    // --- UI Rendering Functions ---
    
    function updateAnimatedStat(elementId, newValue) {
        const element = document.getElementById(elementId);
        const newValueString = String(newValue); 
        
        if (element && element.textContent !== newValueString) {
            element.textContent = newValueString;
            
            // Find the closest ancestor that is a '.stat-item' or '.action-item'
            let animatedParent = element.closest('.stat-item') || element.closest('.action-item');
            
            // Check if the element being updated is a span inside an action-item (for feed updates)
            if (!animatedParent && element.classList.contains('stat-value')) {
                animatedParent = element.closest('.action-item');
            }

            if (animatedParent) {
                animatedParent.classList.add('stat-animated'); 
                setTimeout(() => animatedParent.classList.remove('stat-animated'), 500);
            }
        }
    }

    // Helper for rendering Avatars (PFP support)
    function createAvatarHTML(initial, color, pfp, sizeClass = '', attributes = '') {
        const finalColor = color === 'var(--primary-blue)' ? userProfile.themeColor : color;
        const style = pfp 
            ? `background-image: url('${pfp}'); background-color: ${finalColor};`
            : `background-color: ${finalColor};`;
        const content = pfp ? '' : initial;
        return `<div class="avatar ${sizeClass}" style="${style}" ${attributes}>${content}</div>`;
    }

    function updateProfileUI() {
        // Update userProfile based on latest saved data
        userProfile.initial = userProfile.name.charAt(0).toUpperCase() || 'Y';
        userProfile.handle = `@${userProfile.name.replace(/[^a-zA-Z0-9_]/g, '')}`;

        // Global Avatars
        // Use outerHTML to completely replace the element and its event handlers
        headerAvatar.outerHTML = createAvatarHTML(userProfile.initial, 'var(--primary-blue)', userProfile.pfp, '', `id="headerAvatar" onclick="showProfile('user')"`);
        modalAvatar.outerHTML = createAvatarHTML(userProfile.initial, 'var(--primary-blue)', userProfile.pfp, '', `id="modalAvatar"`);
        
        // Re-get elements after replacement
        window.headerAvatar = document.getElementById('headerAvatar');
        window.modalAvatar = document.getElementById('modalAvatar');
        
        saveData();
    }
    
    // Helper for Ad-specific action buttons/links
    function createAdAction(post) {
        if (post.adDetails.actionButton) {
            // Use var(--primary-color) for the background via the class
            return `
                <div style="margin-top: 10px;">
                    <button class="follow-button theme-bg-dynamic" style="color: white; padding: 6px 15px;" onclick="${post.adDetails.actionFunction}">
                        Activate Premium
                    </button>
                </div>
            `;
        } else if (post.adDetails.actionLink) {
            return `
                <div style="margin-top: 10px; border-top: 1px solid var(--x-border); padding-top: 10px;">
                    <a href="${post.adDetails.actionLink}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">
                        Visit PUNSTA.com <i class="fas fa-external-link-alt" style="margin-left: 5px;"></i>
                    </a>
                </div>
            `;
        }
        return '';
    }

    function createPostHTML(post, isUser = true, isDetailView = false) {
        const stats = updatePostStats(post);
        const verifiedBadge = '<i class="fas fa-certificate verified-badge"></i>';
        const adBadge = '<span class="ad-badge" style="background-color: var(--x-dim-text); color: var(--x-dark); font-size: 10px; padding: 2px 4px; border-radius: 4px; font-weight: bold; margin-left: 5px;">AD</span>';
        const isAd = post.type && post.type.startsWith('ad_');
        
        let initial, rawDisplayName, displayName, color, pfp, clickHandler;

        if (isAd) {
            initial = post.adDetails.initial;
            rawDisplayName = post.adDetails.name;
            displayName = post.adDetails.handle;
            color = post.adDetails.color;
            pfp = null; 
            clickHandler = 'void(0)'; 
        } else if (!isUser) {
            initial = post.user.initial;
            rawDisplayName = post.user.name;
            displayName = post.user.handle;
            color = post.user.color;
            pfp = post.user.pfp;
            clickHandler = `showProfile('bot', ${post.user.id})`;
        } else {
            initial = userProfile.initial;
            rawDisplayName = userProfile.name;
            displayName = userProfile.handle;
            color = 'var(--primary-blue)'; 
            pfp = userProfile.pfp;
            clickHandler = `showProfile('user')`;
        }

        const avatarHTML = createAvatarHTML(initial, color, pfp);
        const contentWithLinks = linkHashtags(post.content);
        const postContentHTML = `<div class="${isDetailView ? 'post-detail-content' : 'post-content'}">${contentWithLinks}</div>`;
        
        // Post Detail Stats (now with IDs for dynamic animation)
        const postStatsHTML = isDetailView ? `
            <div class="post-detail-stats">
                <div class="stat-item"><strong id="detail-stats-likes">${stats.likes}</strong> Likes</div>
                <div class="stat-item"><strong id="detail-stats-reposts">${stats.reposts}</strong> Reposts</div>
                <div class="stat-item"><strong id="detail-stats-comments">${stats.comments}</strong> Comments</div>
                <div class="stat-item"><strong id="detail-stats-views">${stats.views}</strong> Views</div>
            </div>
        ` : ``;

        const postActionsClass = isDetailView ? 'post-actions post-detail-actions' : 'post-actions';

        // Determine the badge
        let postBadge;
        if (isAd) {
            postBadge = adBadge;
        } else if (userProfile.isPremium && isUser) {
            postBadge = `<i class="${userProfile.premiumBadge}" style="color: gold; font-size: 14px; margin-left: 5px;"></i>`;
        } else {
            postBadge = verifiedBadge;
        }

        // Use distinct IDs for the action-item children in the feed view
        const statIds = {
            comments: isDetailView ? '' : `id="stat-comment-${post.id}"`,
            reposts: isDetailView ? '' : `id="stat-repost-${post.id}"`,
            likes: isDetailView ? '' : `id="stat-like-${post.id}"`,
            views: isDetailView ? '' : `id="stat-view-${post.id}"`
        };


        const postBody = `
            <div class="post-body">
                <div class="post-header-info">
                    <span class="post-author-name" onclick="${clickHandler}">${rawDisplayName}</span>
                    ${postBadge}
                    <span class="post-author-handle" onclick="${clickHandler}">${displayName}</span>
                    <span style="color: var(--x-dim-text); margin-left: 5px;">· ${timeAgo(post.timestamp)}</span>
                </div>
                
                ${postContentHTML}
                
                ${isDetailView ? `<div class="post-detail-timestamp">${new Date(post.timestamp).toLocaleTimeString()} · ${new Date(post.timestamp).toLocaleDateString()}</div>` : ''}

                ${postStatsHTML}
                
                ${isAd ? createAdAction(post) : ''}
                
                <div class="${postActionsClass}">
                    <div class="action-item comment" id="action-comment-${post.id}" onclick="alert('Comment box simulation.')"><i class="far fa-comment"></i> ${isDetailView ? '' : `<span class="stat-value" ${statIds.comments}>${stats.comments}</span>`}</div>
                    <div class="action-item repost" id="action-repost-${post.id}" onclick="alert('Repost simulation.')"><i class="fas fa-retweet"></i> ${isDetailView ? '' : `<span class="stat-value" ${statIds.reposts}>${stats.reposts}</span>`}</div>
                    <div class="action-item like" id="action-like-${post.id}" onclick="alert('Like simulation.')"><i class="far fa-heart"></i> ${isDetailView ? '' : `<span class="stat-value" ${statIds.likes}>${stats.likes}</span>`}</div>
                    
                    ${isDetailView ? '' : `<div class="action-item view-count" id="action-view-${post.id}"><i class="fas fa-eye"></i> <span class="stat-value" ${statIds.views}>${stats.views}</span></div>`}
                    
                    <div class="action-item share" onclick="alert('Share simulation.')" style="${isDetailView ? '' : 'margin-left: auto;'}"><i class="fas fa-arrow-up-from-bracket"></i></div>
                </div>
            </div>
        `;
        
        // Return full post structure, with onclick for non-detail view
        if (isDetailView) {
            return postBody;
        } else {
            return `
                <div class="post" id="post-${post.id}" onclick="showPostDetails(${post.id})">
                    ${avatarHTML} <div class="post-content-container"> 
                        ${postBody} 
                    </div>
                </div>
            `;
        }
    }

    function updateFeedStats(targetFeed) {
        // Find all post elements in the target feed
        const postElements = targetFeed.querySelectorAll('.post');
        
        postElements.forEach(postEl => {
            const postIdMatch = postEl.id.match(/post-(\d+)/);
            if (!postIdMatch) return;
            
            const postId = parseInt(postIdMatch[1]);
            const post = findPostById(postId);
            
            if (post) {
                const stats = updatePostStats(post);
                
                // Update stats and trigger animation using the correct ID structure
                updateAnimatedStat(`stat-comment-${post.id}`, stats.comments);
                updateAnimatedStat(`stat-repost-${post.id}`, stats.reposts);
                updateAnimatedStat(`stat-like-${post.id}`, stats.likes);
                updateAnimatedStat(`stat-view-${post.id}`, stats.views);
            }
        });
    }

    function renderFeed() {
        const targetFeed = feed;
        if (currentTab !== 'home') {
            targetFeed.innerHTML = `<div style="padding: 20px; text-align: center;"><h2 style="color: var(--x-text-color);">${currentTab.charAt(0).toUpperCase() + currentTab.slice(1)}</h2><p style="color: var(--x-dim-text);">This tab is currently a **simulation**.</p></div>`;
            return;
        }

        const combinedFeed = [
            ...userPosts.map(p => ({...p, isUser: true})), 
            ...botPosts.map(p => ({...p, isUser: false}))
        ];
        combinedFeed.sort((a, b) => b.timestamp - a.timestamp);

        let newHTML = '';
        let postCount = 0;
        let adIndex = 0;
        
        // Ad Insertion Logic (One ad only, after the 7th post)
        const adInterval = 7; 

        for(let i = 0; i < combinedFeed.length; i++) {
            const post = combinedFeed[i];
            
            // Check for Ad Insertion point
            if (adIndex < adPosts.length && postCount === adInterval) {
                newHTML += createPostHTML(adPosts[adIndex], false); 
                adIndex++;
            }

            newHTML += createPostHTML(post, post.isUser);
            postCount++;
        }
        
        // Add remaining ads if the feed was short
        while(adIndex < adPosts.length) {
            newHTML += createPostHTML(adPosts[adIndex], false);
            adIndex++;
        }
        
        // Full re-render needed when re-sorting or adding new posts (like from the bot generator)
        targetFeed.innerHTML = newHTML;
    }
    
    // Post Detail Rendering
    function showPostDetails(postId) {
        const post = findPostById(postId);
        if (!post) return;
        
        // Save the previous tab so we can go "back"
        document.getElementById('postDetailView').setAttribute('data-previous-tab', currentTab);
        
        // Switch to the detail view
        switchView('postDetail');
        
        const detailContainer = document.getElementById('postDetailContent');
        detailContainer.setAttribute('data-post-id', postId); // Store ID for stat updates
        
        const postHTML = createPostHTML(post, post.isUser, true);
        
        detailContainer.innerHTML = `
            <div class="post-detail-post-container">
                ${postHTML}
            </div>
            <div class="comments-section">
                <i class="fas fa-exclamation-circle" style="margin-right: 5px;"></i> Comments unavailable, coming soon.
            </div>
        `;
    }

    function getTrendingHashtags() {
        const allPosts = [...userPosts, ...botPosts, ...adPosts];
        const hashtagData = {};
        
        allPosts.forEach(post => {
            const tags = extractHashtags(post.content);
            tags.forEach(tag => {
                if (!hashtagData[tag]) {
                    hashtagData[tag] = { views: 0, count: 0 };
                }
                hashtagData[tag].views += post.baseViews;
                hashtagData[tag].count++;
            });
        });
        
        // Convert to array, sort by views, and take top 10
        const sortedHashtags = Object.keys(hashtagData)
            .map(tag => ({
                tag: tag,
                views: hashtagData[tag].views
            }))
            .sort((a, b) => b.views - a.views)
            .slice(0, 10);
            
        return sortedHashtags;
    }
    
    function renderTrending() {
        switchView('trending');
        
        const trendingList = document.getElementById('trendingList');
        const hashtags = getTrendingHashtags();
        
        let html = '';
        if (hashtags.length === 0) {
            html = `<div style="padding: 20px; text-align: center; color: var(--x-dim-text);">No hashtags are currently trending. Post one to start!</div>`;
        } else {
            hashtags.forEach((trend, index) => {
                html += `
                    <div class="trending-item" onclick="showHashtagPosts('${trend.tag}')">
                        <div class="trending-category">${index + 1} · Trending</div>
                        <div class="trending-hashtag">#${trend.tag}</div>
                        <div class="trending-views">${formatNumber(trend.views)} views</div>
                    </div>
                `;
            });
        }
        
        trendingList.innerHTML = html;
    }

    function renderCommunities() {
        switchView('communities');
        
        let html = '<h2 style="padding: 10px 15px;">Trending Communities</h2><div class="community-list">';
        communitiesData.forEach(comm => {
            html += `
                <div class="community-item" onclick="alert('Joining ${comm.name}! (Simulated)')">
                    <div class="community-icon" style="background-color: ${comm.color};">
                        <i class="${comm.icon}"></i>
                    </div>
                    <div class="community-details">
                        <strong style="display: flex; align-items: center;">${comm.name} <i class="fas fa-certificate verified-badge"></i></strong>
                        <div class="members">${comm.handle} · ${comm.members} Members</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        document.getElementById('communityList').innerHTML = html;
    }

    function renderProfilePosts(onlyUpdateFeed = false) {
        let postsToRender = [];
        let profileDetails = {};
        
        if (currentProfileView === 'user') {
            postsToRender = userPosts;
            profileDetails = {
                name: userProfile.name,
                handle: userProfile.handle,
                avatarInitial: userProfile.initial,
                avatarColor: 'var(--primary-blue)',
                bio: userProfile.bio,
                location: userProfile.location,
                joined: userProfile.joined,
                posts: userPosts.length,
                followers: userProfile.followers, 
                following: userProfile.following,
                isBot: false,
                banner: userProfile.banner
            };
        } else {
            const bot = botData.find(b => b.id === currentProfileView.id);
            postsToRender = botPosts.filter(p => p.user.id === bot.id);
            profileDetails = {
                name: bot.name,
                handle: bot.handle,
                avatarInitial: bot.initial,
                avatarColor: bot.color,
                bio: bot.bio,
                location: bot.location,
                joined: bot.joined,
                posts: postsToRender.length,
                followers: bot.followers,
                following: bot.following,
                isBot: true,
                banner: bot.color 
            };
        }

        // Only update the profile header if it's the initial render
        if (!onlyUpdateFeed) {
            document.getElementById('profileDisplayName').textContent = profileDetails.name;
            document.getElementById('profileHandle').textContent = profileDetails.handle;
            document.getElementById('profileBio').textContent = profileDetails.bio;
            document.getElementById('profileLocation').textContent = profileDetails.location;
            document.getElementById('profileJoined').textContent = profileDetails.joined;
            
            const pfpElement = document.getElementById('profilePageAvatar');
            const finalColor = profileDetails.avatarColor === 'var(--primary-blue)' ? userProfile.themeColor : profileDetails.avatarColor;
            pfpElement.style.backgroundColor = finalColor;
            pfpElement.style.backgroundImage = profileDetails.pfp ? `url('${profileDetails.pfp}')` : '';
            pfpElement.textContent = profileDetails.pfp ? '' : profileDetails.avatarInitial;
            
            document.getElementById('profileBanner').style.background = profileDetails.banner.startsWith('#') || profileDetails.banner.includes('url') || profileDetails.banner.includes('gradient')
                ? profileDetails.banner 
                : `linear-gradient(135deg, ${profileDetails.banner}, #333)`;

            const followBtn = document.getElementById('followButton');
            const editBtn = document.getElementById('editProfileButton');

            if (profileDetails.isBot) {
                editBtn.style.display = 'none';
                followBtn.style.display = 'block';
                followBtn.textContent = 'Follow';
                followBtn.onclick = () => alert(`You followed ${profileDetails.handle}! (Simulation only)`);
            } else {
                followBtn.style.display = 'none';
                editBtn.style.display = 'block';
            }
        }

        // Update animated stats (always run, even if onlyUpdateFeed is true)
        updateAnimatedStat('profilePostCount', profileDetails.posts); // Posts count changes when a new post is made
        updateAnimatedStat('profileFollowerCount', profileDetails.followers);
        updateAnimatedStat('profileFollowingCount', profileDetails.following);
        
        // Update the posts feed itself
        postsToRender.sort((a, b) => b.timestamp - a.timestamp);
        
        if (!onlyUpdateFeed) {
            profilePostsFeed.innerHTML = postsToRender.map(p => createPostHTML(p, !profileDetails.isBot)).join('');
        } else {
            updateFeedStats(profilePostsFeed);
        }
    }
    
    function showHashtagPosts(hashtag) {
        // Save the previous tab so we can go "back"
        hashtagModal.setAttribute('data-previous-tab', currentTab);
        
        switchView(null); // Hide everything else
        hashtagModal.style.display = 'flex';
        
        document.getElementById('hashtagModalTitle').textContent = `#${hashtag}`;
        renderHashtagFeed(hashtag);
    }
    
    function renderHashtagFeed(hashtag, onlyUpdateFeed = false) {
        const allPosts = [...userPosts.map(p => ({...p, isUser: true})), ...botPosts.map(p => ({...p, isUser: false}))];
        
        const filteredPosts = allPosts.filter(post => {
            const tags = extractHashtags(post.content);
            return tags.includes(hashtag);
        }).sort((a, b) => b.timestamp - a.timestamp); // Sort by recency

        const targetFeed = document.getElementById('hashtagPostsFeed');
        
        if (!onlyUpdateFeed) {
             // Full render if not just updating stats
            targetFeed.innerHTML = filteredPosts.map(p => createPostHTML(p, p.isUser)).join('');
        } else {
            // Stat update logic (rely on interval function's stat animation)
            updateFeedStats(targetFeed);
        }
    }

    function closeHashtagModal() {
        hashtagModal.style.display = 'none';
        switchTab(hashtagModal.getAttribute('data-previous-tab') || 'home');
    }


    // --- Profile Editing Logic ---

    function openEditProfileModal() {
        document.getElementById('editDisplayName').value = userProfile.name;
        document.getElementById('editFollowers').value = userProfile.followers;
        document.getElementById('editBio').value = userProfile.bio;
        document.getElementById('editLocation').value = userProfile.location;
        document.getElementById('editJoined').value = userProfile.joined;

        // Preview PFP
        const editAvatar = document.getElementById('editProfileAvatar');
        editAvatar.style.backgroundColor = userProfile.themeColor; // Use theme color
        editAvatar.style.backgroundImage = userProfile.pfp ? `url('${userProfile.pfp}')` : '';
        editAvatar.textContent = userProfile.pfp ? '' : userProfile.initial;
        
        // Preview Banner
        document.getElementById('editBanner').style.background = userProfile.banner.startsWith('#') || userProfile.banner.includes('url') || userProfile.banner.includes('gradient')
            ? userProfile.banner 
            : `linear-gradient(135deg, ${userProfile.themeColor}, #333)`;

        editProfileModal.style.display = 'flex';
    }

    function closeEditProfileModal() {
        editProfileModal.style.display = 'none';
        pfpInput.value = ''; // Clear file input
    }
    
    // Handle File Input and Base64 Conversion
    pfpInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                userProfile.pfp = e.target.result;
                document.getElementById('editProfileAvatar').style.backgroundImage = `url('${e.target.result}')`;
                document.getElementById('editProfileAvatar').textContent = '';
                updateProfileUI(); 
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    function saveProfileChanges() {
        userProfile.name = document.getElementById('editDisplayName').value.trim() || "YourName";
        userProfile.followers = document.getElementById('editFollowers').value.trim() || "0";
        userProfile.bio = document.getElementById('editBio').value.trim();
        userProfile.location = document.getElementById('editLocation').value.trim();
        userProfile.joined = document.getElementById('editJoined').value.trim();
        
        userProfile.initial = userProfile.name.charAt(0).toUpperCase() || 'Y';
        userProfile.handle = `@${userProfile.name.replace(/[^a-zA-Z0-9_]/g, '')}`;

        saveData();
        updateProfileUI(); 
        renderProfilePosts(); 
        closeEditProfileModal();
    }

    // --- Settings Modal Logic ---

    function openSettingsModal(navItem) {
        // Switch active nav item
        document.getElementById('bottomNav').querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        navItem && navItem.classList.add('active');
        
        // Hide all main content views
        switchView(null);
        
        // Set active theme button
        document.getElementById('themeOptions').querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-color') === userProfile.themeColor) {
                btn.classList.add('active');
            }
        });
        
        // Update premium buttons visibility/enabled state
        document.getElementById('themeOptions').querySelectorAll('[data-color*="gradient"]').forEach(btn => {
            btn.disabled = !userProfile.isPremium;
            btn.title = userProfile.isPremium ? 'Premium Theme' : 'Premium Only';
        });


        settingsModal.style.display = 'flex';
    }

    function closeSettingsModal() {
        settingsModal.style.display = 'none';
        
        // Re-activate the last tab that was visible (home by default)
        switchTab(currentTab);
    }
    
    // --- Premium Simulation Logic ---
    function openPremiumModal() {
        settingsModal.style.display = 'none';
        const premiumModal = document.getElementById('premiumModal');
        premiumModal.querySelector('button').textContent = userProfile.isPremium ? 'Premium is ACTIVE!' : 'Activate Premium Now';
        premiumModal.style.display = 'flex';
    }

    function closePremiumModal() {
        document.getElementById('premiumModal').style.display = 'none';
        openSettingsModal(); // Go back to settings
    }

    function promptPremiumCode() {
        if (userProfile.isPremium) {
            alert("Premium is already active! Enjoy your 3x view growth.");
            return;
        }

        const code = prompt("Enter the secret code to activate Premium:");
        const secretCode = "3931";
        
        if (code === secretCode) {
            userProfile.isPremium = true;
            userProfile.viewGrowthMultiplier = 3; // 3x growth!
            saveData();
            alert("🎉 Premium Activated! Your view counts are now 3x faster. Check your Profile and Theme settings!");
            closePremiumModal();
            renderProfilePosts(); // Refresh profile to show new badge
            renderFeed(); // Refresh feed to show updated AD button
        } else if (code !== null) {
            alert("Incorrect code. No one knows it!");
        }
    }


    // --- View Switching Logic ---

    function switchView(view) {
        // Hide all main content views
        mainView.style.display = 'none';
        profileView.style.display = 'none';
        communitiesView.style.display = 'none';
        trendingView.style.display = 'none';
        postDetailView.style.display = 'none'; 
        hashtagModal.style.display = 'none';
        headerTabs.style.display = 'flex'; 
        settingsModal.style.display = 'none'; 
        document.getElementById('premiumModal').style.display = 'none'; // Hide premium modal

        if (view === 'main') {
            mainView.style.display = 'block';
        } else if (view === 'profile') {
            profileView.style.display = 'block';
            headerTabs.style.display = 'none';
        } else if (view === 'communities') {
            communitiesView.style.display = 'block';
            headerTabs.style.display = 'none'; 
        } else if (view === 'trending') {
            trendingView.style.display = 'block';
            headerTabs.style.display = 'flex'; 
        } else if (view === 'postDetail') { 
            postDetailView.style.display = 'block';
            headerTabs.style.display = 'none';
        }
    }
    
    function showProfile(type, botId = null) {
        if (type === 'user') {
            currentProfileView = 'user';
        } else if (type === 'bot') {
            const bot = botData.find(b => b.id === botId);
            if(bot) {
                currentProfileView = bot;
            } else {
                return;
            }
        }

        switchView('profile');
        renderProfilePosts();
    }

    function switchTab(tabName, navItem = null) {
        currentTab = tabName;
        
        // Update Bottom Nav
        document.getElementById('bottomNav').querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-tab') === tabName) {
                item.classList.add('active');
            }
        });
        
        // Update Header Tabs (only applies to Home/Trending)
        document.getElementById('headerTabs').querySelectorAll('.tab-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-tab') === tabName) {
                item.classList.add('active');
            }
        });
        
        if (tabName === 'communities') {
            renderCommunities();
        } else if (tabName === 'trending') {
            renderTrending();
        } else if (tabName === 'settings') {
            openSettingsModal(document.querySelector('.nav-item[data-tab="settings"]'));
        } else {
            switchView('main');
            renderFeed();
        }
    }
    
    // --- Post/Modal Logic ---

    function checkPostLength() {
        modalPostButton.disabled = postTextarea.value.trim() === "";
    }

    function openPostModal() {
        postModal.style.display = 'flex';
        checkPostLength();
    }

    function closePostModal() {
        postModal.style.display = 'none';
        postTextarea.value = '';
    }

    function postTweet() {
        const content = postTextarea.value.trim();
        if (content === "") return;

        const newPost = {
            id: Date.now(),
            content: content,
            timestamp: Date.now(),
            baseLikes: 0,
            baseReposts: 0,
            baseComments: 0,
            baseViews: 0
        };

        userPosts.unshift(newPost); // Add to the start
        
        // Update post count immediately, triggering animation
        updateAnimatedStat('profilePostCount', userPosts.length);

        // FIX: Close modal and switch to home tab, which will trigger a full feed re-render.
        closePostModal();
        switchTab('home'); 
    }

    // --- Initialization ---

    loadData();

</script>

</body>
</html>